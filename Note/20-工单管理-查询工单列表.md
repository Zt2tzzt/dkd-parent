# 工单管理之查询工单列表

目前，“运营工单”、“运维工单”两个菜单中，展示的内容是完全一样的。

对两个页面中，查询工单列表的功能进行改造。

## 一、查看工单列表接口文档

**Path：** /manage/task/list

**Method：** GET

请求参数：Query

| 参数名称         | 是否必须 | 示例 | 备注                         |
| ---------------- | -------- | ---- | ---------------------------- |
| pageNum          | 是       |      |                              |
| pageSize         | 是       |      |                              |
| taskCode         | 否       |      | 工单编号                     |
| taskStatus       | 否       |      | 工单状态                     |
| productTypeId    | 否       |      | 工单类型                     |
| params[isRepair] | 是       | true | true 运维工单 false 运营工单 |

返回数据

| 名称             | 类型      | 是否必须 | 默认值 | 备注     | 其他信息          |
| ---------------- | --------- | -------- | ------ | -------- | ----------------- |
| total            | number    | 必须     |        |          |                   |
| rows             | object [] | 必须     |        |          | item 类型: object |
| ├─ createTime    | string    | 必须     |        |          |                   |
| ├─ taskId        | number    | 必须     |        |          |                   |
| ├─ taskCode      | string    | 必须     |        |          |                   |
| ├─ taskStatus    | number    | 必须     |        |          |                   |
| ├─ createType    | number    | 必须     |        |          |                   |
| ├─ innerCode     | string    | 必须     |        |          |                   |
| ├─ userId        | number    | 必须     |        |          |                   |
| ├─ userName      | string    | 必须     |        |          |                   |
| ├─ regionId      | number    | 必须     |        |          |                   |
| ├─ desc          | string    | 必须     |        |          |                   |
| ├─ productTypeId | number    | 必须     |        |          |                   |
| ├─ assignorId    | number    | 必须     |        |          |                   |
| ├─ addr          | string    | 必须     |        |          |                   |
| ├─ taskType      | object    | 必须     |        | 工单类型 |                   |
| ├─ typeId        | number    | 必须     |        |          |                   |
| ├─ typeName      | string    | 必须     |        |          |                   |
| ├─ type          | number    | 必须     |        |          |                   |
| code             | number    | 必须     |        |          |                   |
| msg              | string    | 必须     |        |          |                   |

### 1.1.接口请求参数接受

请求参数接受的分析：

`pageNum`、`pageSize` 两参数，会被 PageHelper 分页插件接收。

`taskCode`，`taskStatus`，`productTypeId` 三参数，会被 Task 实体类接收。

`params` 参数，会被 Task 继承的 BaseEntity 类接收。

dkd-common/src/main/java/com/dkd/common/core/domain/BaseEntity.java

```java
/** 请求参数 */
@JsonInclude(JsonInclude.Include.NON_EMPTY)
private Map<String, Object> params;
```

## 二、查看工单列表后端改造

### 2.1.VO 类设计

`TaskVO` 类

dkd-manage/src/main/java/com/dkd/manage/domain/vo/TaskVO.java

```java
package com.dkd.manage.domain.vo;

import com.dkd.manage.domain.Task;
import com.dkd.manage.domain.TaskType;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;

@EqualsAndHashCode(callSuper = true)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class TaskVO extends Task {
    // 工单类型
    private TaskType taskType;
}
```

### 2.2.Task Mapper 层改造

`TaskMapper` 接口

dkd-manage/src/main/java/com/dkd/manage/mapper/TaskMapper.java

```java
/**
 * 查询工单列表
 *
 * @param task 工单
 * @return List<TaskVO>
 */
List<TaskVO> selectTasVOList(Task task);
```

XML 映射文件

dkd-manage/src/main/resources/mapper/manage/TaskMapper.xml

```xml
<resultMap type="TaskVO" id="TaskVOResult">
    <result property="taskId" column="task_id"/>
    <result property="taskCode" column="task_code"/>
    <result property="taskStatus" column="task_status"/>
    <result property="createType" column="create_type"/>
    <result property="innerCode" column="inner_code"/>
    <result property="userId" column="user_id"/>
    <result property="userName" column="user_name"/>
    <result property="regionId" column="region_id"/>
    <result property="desc" column="desc"/>
    <result property="productTypeId" column="product_type_id"/>
    <result property="assignorId" column="assignor_id"/>
    <result property="addr" column="addr"/>
    <result property="createTime" column="create_time"/>
    <result property="updateTime" column="update_time"/>
    <association property="taskType" javaType="TaskType" column="product_type_id"
                 select="com.dkd.manage.mapper.TaskTypeMapper.selectTaskTypeByTypeId"/>
</resultMap>

<select id="selectTasVOList" resultMap="TaskVOResult">
    <include refid="selectTaskVo"/>
    <where>
        <if test="taskCode != null  and taskCode != ''">and task_code = #{taskCode}</if>
        <if test="taskStatus != null ">and task_status = #{taskStatus}</if>
        <if test="createType != null ">and create_type = #{createType}</if>
        <if test="innerCode != null  and innerCode != ''">and inner_code = #{innerCode}</if>
        <if test="userId != null ">and user_id = #{userId}</if>
        <if test="userName != null  and userName != ''">and user_name like concat('%', #{userName}, '%')</if>
        <if test="regionId != null ">and region_id = #{regionId}</if>
        <if test="desc != null  and desc != ''">and `desc` = #{desc}</if>
        <if test="productTypeId != null ">and product_type_id = #{productTypeId}</if>
        <if test="assignorId != null ">and assignor_id = #{assignorId}</if>
        <if test="addr != null  and addr != ''">and addr = #{addr}</if>
        <if test="params.isRepair != null and params.isRepair == 'true'">
            AND product_type_id IN (1, 3, 4)
        </if>
        <if test="params.isRepair != null and params.isRepair == 'false'">
            AND product_type_id = 2
        </if>
    </where>
    ORDER BY create_time DESC
</select>
```

- 注意：HTTP1.1 协议，通过 GET 请求的 query 参数，传递的 true、false 等布尔值，都是**字符串**的形式。

### 2.3.Task Service 层改造

`ITaskService` 接口

dkd-manage/src/main/java/com/dkd/manage/service/ITaskService.java

```java
/**
 * 查询工单列表
 *
 * @param task 工单
 * @return List<TaskVO>
 */
List<TaskVO> selectTaskVOList(Task task);
```

`TaskServiceImpl` 实现类

dkd-manage/src/main/java/com/dkd/manage/service/impl/TaskServiceImpl.java

```java
/**
 * 查询工单列表
 *
 * @param task 工单
 * @return List<TaskVO>
 */
@Override
public List<TaskVO> selectTaskVOList(Task task) {
    return taskMapper.selectTasVOList(task);
}
```

### 2.4.Task Controller 层改造

`TaskController` 控制器类；

- 在其中调用 `selectTaskVOList` 方法。

dkd-manage/src/main/java/com/dkd/manage/controller/TaskController.java

```java
/**
 * 查询工单列表
 */
@PreAuthorize("@ss.hasPermi('manage:task:list')")
@GetMapping("/list")
public TableDataInfo list(Task task)
{
    startPage();
    List<TaskVO> list = taskService.selectTaskVOList(task);
    return getDataTable(list);
}
```