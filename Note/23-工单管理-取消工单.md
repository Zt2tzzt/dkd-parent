# 工单管理之取消工单

需求：对于未完成的工单，管理员可以进行取消操作。

## 一、接口文档

### 1.1.基本信息

**Path：** /manage/task/cancel

**Method：** PUT

### 1.2.请求参数

Headers

| 参数名称     | 参数值           | 是否必须 | 示例 | 备注 |
| ------------ | ---------------- | -------- | ---- | ---- |
| Content-Type | application/json | 是       |      |      |

Body

| 名称   | 类型   | 是否必须 | 默认值 | 备注     | 其他信息 |
| ------ | ------ | -------- | ------ | -------- | -------- |
| taskId | number | 必须     |        | 工单Id   |          |
| desc   | string | 必须     |        | 拒绝理由 |          |

### 1.3.返回数据

| 名称 | 类型   | 是否必须 | 默认值 | 备注 | 其他信息 |
| ---- | ------ | -------- | ------ | ---- | -------- |
| msg  | string | 必须     |        |      |          |
| code | number | 必须     |        |      |          |

## 二、Task Controller 层改造

`TaskController.java` 控制器类

dkd-manage/src/main/java/com/dkd/manage/controller/TaskController.java

```java
/**
 * 取消工单
 */
@PreAuthorize("@ss.hasPermi('manage:task:edit')")
@Log(title = "工单", businessType = BusinessType.UPDATE)
@PutMapping("/cancel")
public AjaxResult cancel(@RequestBody Task task) {
    return toAjax(taskService.cancelTask(task));
}
```

## 三、Task Service 层改造

`ITaskService.java` 接口

dkd-manage/src/main/java/com/dkd/manage/service/ITaskService.java

```java
/**
 * 此方法用于：取消工单
 * @param task 工单
 * @return int
 */
int cancelTask(Task task);
```

`TaskServiceImpl.java` 是嫌累

dkd-manage/src/main/java/com/dkd/manage/service/impl/TaskServiceImpl.java

```java
/**
 * 此方法用于：取消工单
 * @param task 工单
 * @return int
 */
@Override
public int cancelTask(Task task) {
    // 判断工单状态是否可以取消
    Task taskDb = taskMapper.selectTaskByTaskId(task.getTaskId());

    // 工单状态，如果已取消，则跑出异常
    if (DkdContants.TASK_STATUS_CANCEL.equals(taskDb.getTaskStatus()))
        throw new ServiceException("该工单已取消了，不能再次取消");

    // 工单状态如果已完成，则抛出异常
    if (DkdContants.TASK_STATUS_FINISH.equals(taskDb.getTaskStatus()))
        throw new ServiceException("该工单已完成，不能取消");

    // 设置更新字段
    task.setTaskStatus(DkdContants.TASK_STATUS_CANCEL); // 工单状态：取消
    task.setUpdateTime(DateUtils.getNowDate());
    return taskMapper.updateTask(task);
}
```
