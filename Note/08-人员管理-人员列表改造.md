# 人员管理之人员列表改造

## 一、列表视图改造

### 1.1.主键 id 改为序号

前端列表视图，添加一个序号列。

src/views/manage/emp/index.vue

```vue
<!-- <el-table-column label="主键" align="center" prop="id" /> -->
<el-table-column label="序号" type="index" align="center" width="50" />
```

## 二、添加、修改对话框改造

### 2.1.角色 id 改为角色

在员工的前端组件上，将添加/修改对话框中的”角色 id“改为”角色“，类型由文本改为下拉框。

在 js 中，添加查询角色列表的逻辑。

src/views/manage/emp/index.vue

```vue
<template>
  ……
  <el-form-item label="角色" prop="roleId">
    <!-- <el-input v-model="form.roleId" placeholder="请输入角色id" /> -->
    <el-select v-model="form.roleId" placeholder="请选择角色">
      <el-option
        v-for="item of roleList"
        :key="item.roleId"
        :label="item.roleName"
        :value="item.roleId"
      ></el-option>
    </el-select>
  </el-form-item>
  ……
</template>

<script>
……
import { listRole } from '@/api/manage/role';
import { loadAllParams } from '@/api/page';
  
const roleList = ref([]);
/** 查询角色列表 */
function getRoleList() {
  listRole(loadAllParams).then(res => {
    roleList.value = res.rows;
  });
}
  
getRoleList();
……
</script>
```

### 3.1.区域 id 改为区域

与上面的做法类似。

在员工的前端组件上，将添加、修改对话框中的”区域 id“改为”区域“，类型由文本改为下拉框。

在 js 中，添加查询区域列表的逻辑。

src/views/manage/emp/index.vue

```vue
<template>
……
  <el-form-item label="负责区域" prop="regionId">
    <!-- <el-input v-model="form.regionId" placeholder="请输入所属区域Id" /> -->
    <el-select v-model="form.regionId" placeholder="请选择负责所属">
      <el-option
        v-for="item of regionList"
        :key="item.id"
        :label="item.name"
        :value="item.id"
      ></el-option>
    </el-select>
  </el-form-item>
……
</template>

<script>
……
import { listRegion } from '@/api/manage/region';
import { loadAllParams } from '@/api/page';
  
const regionList = ref([]);
/** 查询区域列表 */
function getRegionList() {
  listRegion(loadAllParams).then(res => {
    regionList.value = res.rows;
  });
}

getRegionList();
……
</script>
```

## 三、修改对话框改造

### 3.1.创建时间字段添加

在修改对话框中，加入“创建时间”字段。

因为修改对话框，会进行数据回显，所以有记录的 id；

使用 Vue 的 `v-if` 指令。

src/views/manage/emp/index.vue

```vue
<el-form-item label="创建时间" prop="createTime" v-if="form.id">
  {{ form.createTime }}
</el-form-item>
```

## 四、添加、修改员工功能改造（二）

### 4.1.冗余字段存入值

在添加、修改员工时，前端只会传区域 id、角色 id 给到后端；

后端要根据 id 查到区域、角色的名称，存入员工表的 `region_name`、`role_name` 字段中。

dkd-manage/src/main/java/com/dkd/manage/service/impl/EmpServiceImpl.java

```java
/**
 * 新增人员列表
 * 
 * @param emp 人员列表
 * @return 结果
 */
@Override
public int insertEmp(Emp emp)
{
    // 查询区域信息
    emp.setRegionName(regionMapper.selectRegionById(emp.getRegionId()).getName());

    // 查询角色信息
    Role role = roleMapper.selectRoleByRoleId(emp.getRoleId());
    emp.setRoleName(role.getRoleName());
    emp.setRoleCode(role.getRoleCode());

    emp.setCreateTime(DateUtils.getNowDate());
    return empMapper.insertEmp(emp);
}

/**
 * 修改人员列表
 * 
 * @param emp 人员列表
 * @return 结果
 */
@Override
public int updateEmp(Emp emp)
{
    // 查询区域信息
    emp.setRegionName(regionMapper.selectRegionById(emp.getRegionId()).getName());

    // 查询角色信息
    Role role = roleMapper.selectRoleByRoleId(emp.getRoleId());
    emp.setRoleName(role.getRoleName());
    emp.setRoleCode(role.getRoleCode());

    emp.setUpdateTime(DateUtils.getNowDate());
    return empMapper.updateEmp(emp);
}
```

### 4.2.冗余字段同步存储

当区域表的区域名称发生修改后，员工表中的冗余字段 `region_name` 也要同步更新。

在 emp 的 Mapper 层，新增方法 `updateByRegionId`，用于根据区域 id，更新冗余字段 `region_name`;

`EmpMapper` 接口

dkd-manage/src/main/java/com/dkd/manage/mapper/EmpMapper.java

```java
/**
 * 根据 regionId 修改 regionName
 */
@Update("UPDATE emp SET region_name = #{name} WHERE region_id = #{id};")
void updateByRegionId(Region region);
```

在 Region 的 Service 层，改造 `updateRegion` 方法。

`RegionServiceImpl` 实现类：

- 在更新区域时，也更新员工表的 `region_name` 字段。
- 使用 Spring 的事务注解。

dkd-manage/src/main/java/com/dkd/manage/service/impl/RegionServiceImpl.java

```java
/**
 * 修改区域管理
 * 
 * @param region 区域管理
 * @return 结果
 */
@Transactional(rollbackFor = Exception.class)
@Override
public int updateRegion(Region region)
{
    region.setUpdateTime(DateUtils.getNowDate());
    int result = regionMapper.updateRegion(region);
    
    // 冗余字段同步
    empMapper.updateByRegionId(region);
    
    return result;
}
```
