# 工单管理之人员列表

## 一、运营人员列表获取

业务场景：当添加运营工单时，输入设备编号，要根据该设备，查询出可用的运营人员。

### 1.1.接口文档

根据售货机获取运营人员列表，接口文档。

基本信息

**Path：** /manage/emp/businessList/:innerCode

**Method：** GET

请求参数之路径参数

| 参数名称  | 示例 | 备注     |
| --------- | ---- | -------- |
| innerCode |      | 设备编号 |

返回数据

| 名称          | 类型      | 是否必须 | 默认值 | 备注 | 其他信息          |
| ------------- | --------- | -------- | ------ | ---- | ----------------- |
| msg           | string    | 必须     |        |      |                   |
| code          | number    | 必须     |        |      |                   |
| data          | object [] | 必须     |        |      | item 类型: object |
| ├─ createBy   | null      | 必须     |        |      |                   |
| ├─ createTime | null      | 必须     |        |      |                   |
| ├─ updateBy   | null      | 必须     |        |      |                   |
| ├─ updateTime | null      | 必须     |        |      |                   |
| ├─ remark     | null      | 必须     |        |      |                   |
| ├─ id         | number    | 必须     |        |      |                   |
| ├─ userName   | string    | 必须     |        |      |                   |
| ├─ regionId   | number    | 必须     |        |      |                   |
| ├─ regionName | string    | 必须     |        |      |                   |
| ├─ roleId     | number    | 必须     |        |      |                   |
| ├─ roleCode   | string    | 必须     |        |      |                   |
| ├─ roleName   | string    | 必须     |        |      |                   |
| ├─ mobile     | string    | 必须     |        |      |                   |
| ├─ image      | string    | 必须     |        |      |                   |
| ├─ status     | number    | 必须     |        |      |                   |

### 1.2.VendingMachine Mapper 层改造

根据设备编号，查询设备信息。

dkd-manage/src/main/java/com/dkd/manage/mapper/VendingMachineMapper.java

```java
/**
 * 此方法用于：根据设备编号查询设备信息
 * @param innerCode 设备编号
 * @return 设备信息
 */
@Select("SELECT id, inner_code, channel_max_capacity, node_id, addr, last_supply_time, business_type, region_id, partner_id, vm_type_id, vm_status, running_status, longitudes, latitude, client_id, policy_id, create_time, update_time FROM vending_machine WHERE inner_code = #{innerCode}")
VendingMachine selectVendingMachineByInnerCode(String innerCode);
```

### 1.3.VendingMachine Service 层改造

`VendingMachineService.java`

dkd-manage/src/main/java/com/dkd/manage/service/IVendingMachineService.java

```java
/**
 * 此方法用于：根据设备编号查询设备信息
 *
 * @param innerCode 设备编号
 * @return 设备信息
 */
VendingMachine selectVendingMachineByInnerCode(String innerCode);
```

`VendingMachineServiceImpl.java`

dkd-manage/src/main/java/com/dkd/manage/service/impl/VendingMachineServiceImpl.java

```java
/**
 * 此方法用于：根据设备编号查询设备信息
 *
 * @param innerCode 设备编号
 * @return 设备信息
 */
@Override
public VendingMachine selectVendingMachineByInnerCode(String innerCode) {
    return vendingMachineMapper.selectVendingMachineByInnerCode(innerCode);
}
```

### 1.4.Emp Controller 层改造

`EmpController.java` 控制器类中，添加 `businessList` 方法

- 先查询设备信息，获取设备中的区域 id。
- 再根据区域 id、角色编号、员工状态查询运营人员列表。

dkd-manage/src/main/java/com/dkd/manage/controller/EmpController.java

```java
/**
 * 此方法用于：根据售货机设备编号，获取人员列表
 */
@PreAuthorize("@ss.hasPermi('manage:emp:list')")
@GetMapping("/businessList/{innerCode}")
public AjaxResult businessList(@PathVariable("innerCode") String innerCode) {
    // 根据 innerode 查询售货机信息
    VendingMachine vendingMachine = vendingMachineService.selectVendingMachineByInnerCode(innerCode);
    if (vendingMachine == null)
        return error("设备编号不存在");

    // 根据区域 id，角色编号，员工状态，查询运营 人员列表。
    Emp emp = new Emp();
    emp.setRegionId(vendingMachine.getRegionId());
    emp.setRoleCode(DkdContants.ROLE_CODE_BUSINESS); // 运营人员
    emp.setStatus(DkdContants.EMP_STATUS_NORMAL); // 启用

    return success(empService.selectEmpList(emp));
}
```

## 二、运维人员列表获取

需求：根据售货机编号，获取负责当前区域下的运维人员列表。

### 2.1.接口文档

基本信息

**Path：** /manage/emp/operationList/:innerCode

**Method：** GET

请求参数之路径参数：

| 参数名称  | 示例 | 备注     |
| --------- | ---- | -------- |
| innerCode |      | 设备编号 |

返回数据

| 名称          | 类型      | 是否必须 | 默认值 | 备注 | 其他信息          |
| ------------- | --------- | -------- | ------ | ---- | ----------------- |
| msg           | string    | 必须     |        |      |                   |
| code          | number    | 必须     |        |      |                   |
| data          | object [] | 必须     |        |      | item 类型: object |
| ├─ createBy   | null      | 必须     |        |      |                   |
| ├─ createTime | null      | 必须     |        |      |                   |
| ├─ updateBy   | null      | 必须     |        |      |                   |
| ├─ updateTime | null      | 必须     |        |      |                   |
| ├─ remark     | null      | 必须     |        |      |                   |
| ├─ id         | number    | 必须     |        |      |                   |
| ├─ userName   | string    | 必须     |        |      |                   |
| ├─ regionId   | number    | 必须     |        |      |                   |
| ├─ regionName | string    | 必须     |        |      |                   |
| ├─ roleId     | number    | 必须     |        |      |                   |
| ├─ roleCode   | string    | 必须     |        |      |                   |
| ├─ roleName   | string    | 必须     |        |      |                   |
| ├─ mobile     | string    | 必须     |        |      |                   |
| ├─ image      | string    | 必须     |        |      |                   |
| ├─ status     | number    | 必须     |        |      |                   |

### 2.2.Emp Controller 层改造

`EmpController` 控制器类中，新增方法 `operationList`；实现逻辑与上方查询运营人员一致。

dkd-manage/src/main/java/com/dkd/manage/controller/EmpController.java

```java
/**
 * 此方法用于：根据售货机设备编号，获取人员列表
 */
@PreAuthorize("@ss.hasPermi('manage:emp:list')")
@GetMapping("/operationList/{innerCode}")
public AjaxResult operationList(@PathVariable("innerCode") String innerCode) {
    // 根据 innerode 查询售货机信息
    VendingMachine vendingMachine = vendingMachineService.selectVendingMachineByInnerCode(innerCode);
    if (vendingMachine == null)
        return error("设备编号不存在");

    // 根据区域 id，角色编号，员工状态，查询运维人员列表。
    Emp emp = new Emp();
    emp.setRegionId(vendingMachine.getRegionId());
    emp.setRoleCode(DkdContants.ROLE_CODE_OPERATOR); // 运维人员
    emp.setStatus(DkdContants.EMP_STATUS_NORMAL); // 启用

    return success(empService.selectEmpList(emp));
}
```
