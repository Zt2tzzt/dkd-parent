# 设备管理之设备管理改造

将数据库中的错误数据进行修正。

```mysql
update vending_machine set partner_id=2 where id=80;
update vending_machine set addr=(select address from node where id = 1) where node_id=1;
update vending_machine set addr=(select address from node where id = 2) where node_id=2;
```

## 一、搜索框改造

### 1.1.只保留设备编号

src/views/manage/vm/index.vue

```vue
<el-form-item label="设备编号" prop="innerCode">
  <el-input
    v-model="queryParams.innerCode"
    placeholder="请输入设备编号"
    clearable
    @keyup.enter="handleQuery"
  />
</el-form-item>
```

## 二、列表视图改造

对列表视图中的字段顺序，字段 label 进行改造。

src/views/manage/vm/index.vue

```vue
<el-table v-loading="loading" :data="vmList" @selection-change="handleSelectionChange">
  <el-table-column type="selection" width="55" align="center" />
  <!-- <el-table-column label="主键" align="center" prop="id" /> -->
  <el-table-column label="序号" type="index" align="center" width="50" />
  <el-table-column label="设备编号" align="center" prop="innerCode" />
  <el-table-column label="设备型号" align="center" prop="vmTypeId" />
  <el-table-column label="详细地址" align="center" prop="addr" />
  <el-table-column label="合作商" align="center" prop="partnerId" />
  <el-table-column label="设备状态" align="center" prop="vmStatus">
    <template #default="scope">
      <dict-tag :options="vm_status" :value="scope.row.vmStatus"/>
    </template>
  </el-table-column>
  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button link type="primary" @click="handleUpdate(scope.row)" v-hasPermi="['manage:vm:edit']">修改</el-button>
    </template>
  </el-table-column>
</el-table>
```

### 2.1.合作商、设备类型改造

合作商、设备类型都是对应的 id 值。要将它们与名称一一对应起来。

- 思路一：在后端使用 MyBatis 的 `<resultMap>` 标签，进行多表的映射。
- 思路二：在前端页面上先查询**所有的**合作商、设备类型记录，再使用 `<dict-tag>` 数据字典组件的**原理**，进行匹配展示。

这里采用思路二。

src/views/manage/vm/index.vue

```vue
<template>
  <el-table-column label="设备型号" align="center" prop="vmTypeId">
    <template #default="scope">
      <template v-for="item of vmTypeList" :key="item.id">
        <span v-if="item.id === scope.row.vmTypeId">{{ item.name }}</span>
      </template>
    </template>
  </el-table-column>
  ……
  <el-table-column label="合作商" align="center" prop="partnerId">
    <template #default="scope">
      <template v-for="item of partnerList" :key="item.id">
        <span v-if="item.id === scope.row.partnerId">{{ item.name }}</span>
      </template>
    </template>
  </el-table-column>
</template>

<script>
import { listVmType } from '@/api/manage/vmType';
import { listPartner } from '@/api/manage/partner';
import { loadAllParams } from '@/api/page';

……

/** 查询设备类型列表 */
const vmTypeList = ref([]);
function getVmTypeList() {
  listVmType(loadAllParams).then(res => {
    vmTypeList.value = res.rows;
  });
}

/** 查询合作商列表 */
const partnerList = ref([]);
function getPartnerList() {
  listPartner(loadAllParams).then(res => {
    partnerList.value = res.rows;
  });
}

getVmTypeList();
getPartnerList();
</script>
```

## 三、添加、修改对话框改造

### 3.1.设备编号改造

在添加对话框里，设备编号，固定显示：“系统自动生成”。

在修改对话框里，将设备编号进行回显，但不允许更改。

src/views/manage/vm/index.vue

```vue
<el-form-item label="设备编号" prop="innerCode">
  <!-- <el-input v-model="form.innerCode" placeholder="请输入设备编号" /> -->
  <span>{{ form.innerCode ? form.innerCode : '系统自动生成' }}</span>
</el-form-item>
```

### 3.2.设备类型 id 改造

将“设备类型 id”改成“选择设备类型”。利用上文查询到的合作商列表 `vmTypeList`，使用下拉列表进行展示。

src/views/manage/vm/index.vue

```vue
<el-form-item label="选择设备型号" prop="vmTypeId">
  <!-- <el-input v-model="form.vmTypeId" placeholder="请输入设备型号" /> -->
  <el-select v-model="form.vmTypeId" placeholder="请选择设备型号">
    <el-option
      v-for="item in vmTypeList"
      :key="item.id"
      :label="item.name"
      :value="item.id"
    />
  </el-select>
</el-form-item>
```

### 3.3.点位 id 改造

将“点位 id”改成“选择点位”，使用下拉列表进行展示。

参考上文的做法，先查询所有的点位列表，

src/views/manage/vm/index.vue

```vue
<template>
  ……
  <el-form-item label="选择点位" prop="nodeId">
    <!-- <el-input v-model="form.nodeId" placeholder="请输入点位Id" /> -->
    <el-select v-model="form.nodeId" placeholder="请选择点位">
      <el-option
        v-for="item in nodeList"
        :key="item.id"
        :label="item.name"
        :value="item.id"
      />
    </el-select>
  </el-form-item>
  ……
</template>

<script>
import { listNode } from '@/api/manage/node'

……

/** 查询点位列表 */
const nodeList = ref([])
function getNodeList() {
  listNode(loadAllParams).then(res => {
    nodeList.value = res.rows
  })
}

getNodeList()
</script>
```

## 四、修改对话框改造

回显“供货时间”、“设备类型”、"设备容量"、“合作商”、“区域”、“设备地址”，但不允许修改。

隐藏“选择型号”。

思路：使用 `v-if` 指令，判断“设备编号（`innerCode`）”是否存在。存在则表示是修改对话框，不存在则表示是添加对话框。

```vue
<template>
  <!-- 添加或修改设备管理对话框 -->
  <el-dialog :title="title" v-model="open" width="500px" append-to-body>
    <el-form ref="vmRef" :model="form" :rules="rules" label-width="110px">
      <el-form-item label="设备编号" prop="innerCode">
        <!-- <el-input v-model="form.innerCode" placeholder="请输入设备编号" /> -->
        <span>{{ form.innerCode ? form.innerCode : '系统自动生成' }}</span>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="供货时间">
        <span>{{ parseTime(form.lastSupplyTime) }}</span>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="设备类型">
        <template v-for="item of vmTypeList" :key="item.id">
          <span v-if="item.id === form.vmTypeId">{{ item.name }}</span>
        </template>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="设备容量">
        <span>{{ form.channelMaxCapacity }}</span>
      </el-form-item>
      <el-form-item v-if="!form.innerCode" item label="选择型号" prop="vmTypeId">
        <!-- <el-input v-model="form.vmTypeId" placeholder="请输入设备型号" /> -->
        <el-select v-model="form.vmTypeId" placeholder="选择型号">
          <el-option
            v-for="item in vmTypeList"
            :key="item.id"
            :label="item.name"
            :value="item.id"
          />
        </el-select>
      </el-form-item>
      <el-form-item label="选择点位" prop="nodeId">
        <!-- <el-input v-model="form.nodeId" placeholder="请输入点位Id" /> -->
        <el-select v-model="form.nodeId" placeholder="请选择点位">
          <el-option
            v-for="item in nodeList"
            :key="item.id"
            :label="item.name"
            :value="item.id"
          />
        </el-select>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="合作商">
        <template v-for="item of partnerList" :key="item.id">
          <span v-if="item.id === form.partnerId">{{ item.name }}</span>
        </template>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="区域">
        <template v-for="item of regionList" :key="item.id">
          <span v-if="item.id === form.regionId">{{ item.name }}</span>
        </template>
      </el-form-item>
      <el-form-item v-if="form.innerCode" label="设备地址">
        <span>{{ form.addr }}</span>
      </el-form-item>
    </el-form>
    <template #footer>
      <div class="dialog-footer">
        <el-button type="primary" @click="submitForm">确 定</el-button>
        <el-button @click="cancel">取 消</el-button>
      </div>
    </template>
  </el-dialog>
</template>

<script>
import { listRegion } from '@/api/manage/region';

/** 查询区域列表 */
const regionList = ref([])
function getRegionList() {
  listRegion(loadAllParams).then(res => {
    regionList.value = res.rows
  })
}

getRegionList()
</script>
```

## 五、添加设备逻辑改造

在添加（新增）设备时，会涉及到如下四张表：

![设备管理新增涉及到表](/Users/zetian/workshop/project/dkd-parent/Note/NodeAssets/设备管理新增涉及到表.png)

在设备的新增逻辑中，补充上图中的高亮字段。

### 5.1.VendingMachine Service 层改造

在 `VendingMachineServiceImpl` 实现类中，修改 `insertVendingMachine` 方法。

- 因为涉及到两张表（`vending_machine`、`channel`）的插入操作，所以要使用事务。
- `UUIDUtils` 是自行封装的一个工具类，用于生成随机字符串。
- 注入 `IVmTypeService`、`INodeService` 的 Bean 对象。分别用于查询对应的设备类型、点位记录。进行数据的补充。
- 注入 `IChannelService` 的 Bean 对象，用于插入货道记录。

dkd-manage/src/main/java/com/dkd/manage/service/impl/VendingMachineServiceImpl.java

```java
@Autowired
private IVmTypeService iVmTypeService;
@Autowired
private INodeService iNodeService;
@Autowired
private IChannelService iChannelService;

……

/**
 * 新增设备管理
 *
 * @param vendingMachine 设备管理
 * @return 结果
 */
@Transactional(rollbackFor = Exception.class)
@Override
public int insertVendingMachine(VendingMachine vendingMachine)
{
    // 1.新增设备
    // 生成 8 位的唯一标识，补充设备编码
    String innerCode = UUIDUtils.getUUID();
    vendingMachine.setInnerCode(innerCode);

    // 查询售货机类型表，补充设备容量
    VmType vmType = iVmTypeService.selectVmTypeById(vendingMachine.getVmTypeId());
    vendingMachine.setChannelMaxCapacity(vmType.getChannelMaxCapacity());

    // 查询点位表，补充区域、合作商、点位等信息
    Node node = iNodeService.selectNodeById(vendingMachine.getNodeId());
    BeanUtils.copyProperties(node, vendingMachine, "id"); // 合作商 id、区域 id
    vendingMachine.setBusinessType(node.getBusinessDistrictType()); // 商圈类型
    vendingMachine.setAddr(node.getAddress()); // 详细地址

    // 补充其他字段
    vendingMachine.setVmStatus(DkdContants.VM_STATUS_NODEPLOY); // 设置设备状态
    vendingMachine.setCreateTime(DateUtils.getNowDate()); // 创建时间
    vendingMachine.setUpdateTime(DateUtils.getNowDate()); // 更新时间
    int result = vendingMachineMapper.insertVendingMachine(vendingMachine);
 
    // 2.新增货道
    ArrayList<Channel> channels = new ArrayList<>();
    for (int i = 1; i <= vmType.getVmRow(); i++) {
        for (int j = 1; j <= vmType.getVmCol(); j++) {
            Channel channel = new Channel();
            channel.setChannelCode(i + "-" + j); // 货道编号
            channel.setVmId(vendingMachine.getId()); // 售货机 id
            channel.setInnerCode(vendingMachine.getInnerCode()); // 设备编码
            channel.setMaxCapacity(vendingMachine.getChannelMaxCapacity()); // 货道最大容量
            channel.setCreateTime(DateUtils.getNowDate());
            channel.setUpdateTime(DateUtils.getNowDate());
            channels.add(channel);
        }
    }
    iChannelService.batchInsertChannel(channels);
    return result;
}
```

### 5.2.Channel Mapper 层改造

新增一个批量插入的方法：

根据已有的 XML 映射文件中，用于插入的动态 SQL，再借助 AIGC 生成批量插入的 SQL。

Prompt 提示词工程：

```markdown
你是一个软件工程师，将下方 MyBatis 的 XML 映射文件中的脚本，改为批量插入操作，不需要使用动态 SQL
<insert id="insertChannel" parameterType="Channel" useGeneratedKeys="true" keyProperty="id">
    insert into channel
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="channelCode != null and channelCode != ''">channel_code,</if>
        <if test="skuId != null">sku_id,</if>
        <if test="vmId != null">vm_id,</if>
        <if test="innerCode != null and innerCode != ''">inner_code,</if>
        <if test="maxCapacity != null">max_capacity,</if>
        <if test="currentCapacity != null">current_capacity,</if>
        <if test="lastSupplyTime != null">last_supply_time,</if>
        <if test="createTime != null">create_time,</if>
        <if test="updateTime != null">update_time,</if>
     </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
        <if test="channelCode != null and channelCode != ''">#{channelCode},</if>
        <if test="skuId != null">#{skuId},</if>
        <if test="vmId != null">#{vmId},</if>
        <if test="innerCode != null and innerCode != ''">#{innerCode},</if>
        <if test="maxCapacity != null">#{maxCapacity},</if>
        <if test="currentCapacity != null">#{currentCapacity},</if>
        <if test="lastSupplyTime != null">#{lastSupplyTime},</if>
        <if test="createTime != null">#{createTime},</if>
        <if test="updateTime != null">#{updateTime},</if>
     </trim>
</insert>
```

AIGC 输出：

```xml
<insert id="batchInsertChannel" parameterType="list" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO channel (
        channel_code,
        sku_id,
        vm_id,
        inner_code,
        max_capacity,
        current_capacity,
        last_supply_time,
        create_time,
        update_time
    ) VALUES
    <foreach collection="list" item="item" separator=",">
        (
            #{item.channelCode},
            #{item.skuId},
            #{item.vmId},
            #{item.innerCode},
            #{item.maxCapacity},
            #{item.currentCapacity},
            #{item.lastSupplyTime},
            #{item.createTime},
            #{item.updateTime}
        )
    </foreach>
</insert>
```

删掉上方插入语句的 sky_id 字段，则插入数据库后该字段默认为 0。

dkd-manage/src/main/resources/mapper/manage/ChannelMapper.xml

```xml
<insert id="batchInsertChannel" parameterType="list" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO channel (
    channel_code,
    vm_id,
    inner_code,
    max_capacity,
    current_capacity,
    last_supply_time,
    create_time,
    update_time
    ) VALUES
    <foreach collection="list" item="item" separator=",">
        (
        #{item.channelCode},
        #{item.vmId},
        #{item.innerCode},
        #{item.maxCapacity},
        #{item.currentCapacity},
        #{item.lastSupplyTime},
        #{item.createTime},
        #{item.updateTime}
        )
    </foreach>
</insert>
```

### 5.3.Channal Service 层改造

在 `ChannelServiceImpl` 实现类中，新增 `batchInsertChannel` 方法。

dkd-manage/src/main/java/com/dkd/manage/service/impl/ChannelServiceImpl.java

```java
@Override
public void batchInsertChannel(List<Channel> channels) {
    channelMapper.batchInsertChannel(channels);
}
```

## 六、修改设备逻辑改造

### 6.1.VendingMachine Service 层改造

在 `VendingMachineServiceImpl` 实现类中，改造 `updateVendingMachine` 方法，加入点位信息的补充。

dkd-manage/src/main/java/com/dkd/manage/service/impl/VendingMachineServiceImpl.java

```java
/**
 * 修改设备管理
 *
 * @param vendingMachine 设备管理
 * @return 结果
 */
@Override
public int updateVendingMachine(VendingMachine vendingMachine) {
    // 查询点位表
    Node node = iNodeService.selectNodeById(vendingMachine.getNodeId());
    BeanUtils.copyProperties(node, vendingMachine, "id"); // 合作商 id、区域 id
    vendingMachine.setBusinessType(node.getBusinessDistrictType()); // 商圈类型
    vendingMachine.setAddr(node.getAddress()); // 设备地址
    vendingMachine.setUpdateTime(DateUtils.getNowDate()); // 更新时间

    return vendingMachineMapper.updateVendingMachine(vendingMachine);
}
```
