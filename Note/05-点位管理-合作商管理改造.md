# 点位管理之合作商管理改造

## 一、合作商名搜索框 label 宽度改造

若依自动生成的合作商名搜索框 label 宽度太小，导致了 label 自动换行。

src/views/manage/partner/index.vue

```vue
<el-form :model="queryParams" ref="queryRef" :inline="true" v-show="showSearch" label-width="90px">
  <el-form-item label="合作商名称" prop="name">
    <el-input
      v-model="queryParams.name"
      placeholder="请输入合作商名称"
      clearable
      @keyup.enter="handleQuery"
    />
  </el-form-item>
  <el-form-item>
    <el-button type="primary" icon="Search" @click="handleQuery">搜索</el-button>
    <el-button icon="Refresh" @click="resetQuery">重置</el-button>
  </el-form-item>
</el-form>
```

- 修改了 `label-width="90px"`。

## 二、主键 id label 改造

在列表视图页面，将”主键 id“的 label 改为“序号”，并提供排序的功能。

src/views/manage/partner/index.vue

```vue
<el-table-column label="序号" type="index" align="center" prop="id" />
```

- `type="index"` 用于设置排序共嗯。
- `width="50"` 用于增加列的宽度。

## 三、联系人、联系电话例改造

将联系人、联系电话列调整到最后。

src/views/manage/partner/index.vue

```vue
<el-table-column type="selection" width="55" align="center" />
<el-table-column label="序号" type="index" align="center" prop="id" />
<el-table-column label="合作商名称" align="center" prop="name" />
<el-table-column label="账号" align="center" prop="account" />
<el-table-column label="分成比例" align="center" prop="profitShare" />
<!-- <el-table-column label="密码" align="center" prop="password" /> -->
<el-table-column label="联系人" align="center" prop="contactPerson" />
<el-table-column label="联系电话" align="center" prop="contactPhone" />
<el-table-column label="操作" align="center" class-name="small-padding fixed-width">
```

## 四、分成比例列改造

分成比例列，值后方加上百分号。

src/views/manage/partner/index.vue

```vue
<el-table-column label="分成比例" align="center">
  <template #default="scope">
    {{ scope.row.profitShare }}%
  </template>
</el-table-column>
```

## 五、操作列图标移除

```vue
<el-button link type="primary" icon="Edit" @click="handleUpdate(scope.row)" v-hasPermi="['manage:region:edit']">修改</el-button>
<el-button link type="primary" icon="Delete" @click="handleDelete(scope.row)" v-hasPermi="['manage:region:remove']">删除</el-button>

<!-- 改为 👇 -->

<el-button link type="primary" @click="handleUpdate(scope.row)" v-hasPermi="['manage:partner:edit']">修改</el-button>
<el-button link type="primary" @click="handleDelete(scope.row)" v-hasPermi="['manage:partner:remove']">删除</el-button>
```

- 去掉了 `icon="xxx"` 属性。

## 六、添加/修改合作商页面改造

### 6.1.密码使用掩码

src/views/manage/partner/index.vue

```vue
<el-form-item label="密码" prop="password">
  <el-input v-model="form.password" type="password" placeholder="请输入密码" />
</el-form-item>
```

- 增加 `type="password"` 属性。

### 6.2.合作商名称 label 宽度

src/views/manage/partner/index.vue

```vue
<el-form ref="partnerRef" :model="form" :rules="rules" label-width="100px">
  ……
</el-form>
```

- 修改了 `label-width="100px"` 属性。

## 七、修改合作商页面改造

修改合作商页面，没有账号、密码字段；并且要展示合作商的创建时间。

思路：

- 修改操作，因为会回显数据记录，所以有记录 id 的；
- 新增操作则不会。

src/views/manage/partner/index.vue

```vue
<el-form-item label="创建时间" prop="createTime" v-if="form.id">
  {{ form.createTime }}
</el-form-item>
<el-form-item label="账号" prop="account" v-if="!form.id">
  <el-input v-model="form.account" placeholder="请输入账号" />
</el-form-item>
<el-form-item label="密码" prop="password" v-if="!form.id">
  <el-input v-model="form.password" type="password" placeholder="请输入密码" />
</el-form-item>
```

- 使用 `v-if` 判断 `form.id` 是否有值，有则是修改页面；否则是添加页面。

## 八、密码加密

目前，合作商的密码，是明文存储在数据库的，安全性低。

使用若依集成的 Spring Security 依赖，进行密码加密处理。

在 `PartnerServiceImpl` 实现类中，改造 `insertPartner` 方法。

dkd-manage/src/main/java/com/dkd/manage/service/impl/PartnerServiceImpl.java

```java
/**
 * 新增合作商管理
 *
 * @param partner 合作商管理
 * @return 结果
 */
@Override
public int insertPartner(Partner partner)
{
    // 使用 Spring Security 对密码进行加密处理
    partner.setPassword(SecurityUtils.encryptPassword(partner.getPassword()));
    partner.setCreateTime(DateUtils.getNowDate());
    return partnerMapper.insertPartner(partner);
}
```

## 九、查看详情改造

在列表视图的“操作”列，添加”查看详情“的按钮。

```vue
<template>
  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button
        link
        type="primary"
        @click="handleDetail(scope.row)"
        v-hasPermi="['manage:partner:query']"
        >查看详情</el-button
      >
    </template>
    ……
  </el-table-column>

……

  <!-- 查看详情对话框 -->
  <el-dialog title="合作商详情" v-model="detailInfoOpen" width="500px" append-to-body>
    <el-row>
      <el-col :span="12">合作商名称：{{ form.name }}</el-col>
      <el-col :span="12">联系人：{{ form.contactPerson }}</el-col>
    </el-row>
    <el-row>
      <el-col :span="12">联系电话：{{ form.contactPhone }}</el-col>
      <el-col :span="12">联系人：{{ form.profitShare }}%</el-col>
    </el-row>
  </el-dialog>
</template>

<script>
……

const detailInfoOpen = ref(false)
/** 查看详情按钮操作 */
const handleDetail = row => {
  reset()
  const _id = row.id || ids.value
  getPartner(_id).then(res => {
    form.value = res.data
    detailInfoOpen.value = true
  })
}

</script>
```

- `manage:partner:query` 表示查询权限。
- `handleDetail` 是新增的方法，用来展示对话框。
- `detailInfoOpen` 状态，用来表示对话框的开启、关闭。

新增的对话框页面不是很美观，使用 AIGC 优化：

Prompt 提示工程输入：

```markdown
你是一个软件工程师，帮我优化下方代码中对话框中的布局
<!-- 查看详情对话框 -->
<el-dialog title="合作商详情" v-model="detailInfoOpen" width="500px" append-to-body>
  <el-row>
    <el-col :span="12">合作商名称：{{ form.name }}</el-col>
    <el-col :span="12">联系人：{{ form.contactPerson }}</el-col>
  </el-row>
  <el-row>
    <el-col :span="12">联系电话：{{ form.contactPhone }}</el-col>
    <el-col :span="12">联系人：{{ form.profitShare }}%</el-col>
  </el-row>
</el-dialog>
```

AIGC 输出

```vue
<!-- 查看详情对话框 -->
<el-dialog
  title="合作商详情"
  v-model="detailInfoOpen"
  width="500px"
  append-to-body
>
  <!-- 使用更清晰的布局 -->
  <el-row :gutter="20" class="dialog-content">
    <el-col :span="12">
      <strong>合作商名称：</strong> {{ form.name }}
    </el-col>
    <el-col :span="12">
      <strong>联系人：</strong> {{ form.contactPerson }}
    </el-col>
  </el-row>
  <el-row :gutter="20" class="dialog-content">
    <el-col :span="12">
      <strong>联系电话：</strong> {{ form.contactPhone }}
    </el-col>
    <el-col :span="12">
      <strong>分润比例：</strong> {{ form.profitShare }}%
    </el-col>
  </el-row>
</el-dialog>

<style scoped>
.dialog-content {
  margin-bottom: 10px; /* 添加下方间距 */
  font-size: 14px;     /* 提高可读性 */
  line-height: 1.6;    /* 增加行高 */
}
</style>
```

- 添加 `gutter` 属性，增加列之间的间距，避免内容太过紧凑。

## 十、增加“点位数”列

在合作商管理的列表视图中，增加“点位数”列。

参考上文【1.3.增加“点位数”列】进行实现。

### 10.1.后端改造

SQL 语句如下；

```mysql
SELECT
    p.id,
    p.name,
    p.contact_person,
    p.contact_phone,
    p.profit_share,
    p.account,
    p.password,
    p.create_time,
    p.update_time,
    p.create_by,
    p.update_by,
    p.remark,
    COUNT(n.id) AS node_count  -- 统计每个合作商的点位数量
FROM partner p
        LEFT JOIN node n ON p.id = n.partner_id  -- 连接点位表
GROUP BY p.id;  -- 按照合作商的 ID 分组
```

VO 类设计

dkd-manage/src/main/java/com/dkd/manage/domain/vo/PartnerVO.java

```java
package com.dkd.manage.domain.vo;

import com.dkd.manage.domain.Partner;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class PartnerVO extends Partner {
    // 点位数量
    private Integer nodeCount;
}
```

Service 层

dkd-manage/src/main/java/com/dkd/manage/service/IPartnerService.java

```java
/**
 * 此方法用于：查询合作商列表
 *
 * @param partner 合作商
 * @return List<PartnerVO>
 */
List<PartnerVO> partnerVOList(Partner partner);
```

dkd-manage/src/main/java/com/dkd/manage/service/impl/PartnerServiceImpl.java

```java
/**
 * 此方法用于：查询合作商列表
 *
 * @param partner 合作商
 * @return List<PartnerVO>
 */
@Override
public List<PartnerVO> partnerVOList(Partner partner) {
    return partnerMapper.selectPartnerVOList(partner);
}
```

Mapper 层

dkd-manage/src/main/java/com/dkd/manage/mapper/PartnerMapper.java

```java
/**
 * 此方法用于：查询合作商列表
 * @param partner partner
 * @return List<PartnerVO>
 */
List<PartnerVO> selectPartnerVOList(Partner partner);
```

Controller 层

dkd-manage/src/main/java/com/dkd/manage/controller/PartnerController.java

```java
/**
 * 查询合作商管理列表
 */
@PreAuthorize("@ss.hasPermi('manage:partner:list')")
@GetMapping("/list")
public TableDataInfo list(Partner partner)
{
    startPage();
    List<PartnerVO> list = partnerService.partnerVOList(partner);
    return getDataTable(list);
}
```

### 10.2.前端改造

src/views/manage/partner/index.vue

```vue
<el-table-column label="点位数" align="center" prop="nodeCount" />
```

## 十一、合作商重制密码

### 11.1.接口文档

基本信息

**Path：** /manage/partner/resetPwd/:id

**Method：** GET

接口描述：

请求参数

路径参数

| 参数名称 | 示例 | 备注     |
| -------- | ---- | -------- |
| id       | 1    | 合作商ID |

返回数据

| 名称 | 类型   | 是否必须 | 默认值 | 备注     | 其他信息       |
| ---- | ------ | -------- | ------ | -------- | -------------- |
| msg  | string | 必须     |        | 返回内容 | mock: 操作成功 |
| code | number | 必须     |        | 状态码   | mock: 200      |

### 11.2.后端改造

在 `PartnerController` 控制器类中，新增 `resetPwd` 方法。

dkd-manage/src/main/java/com/dkd/manage/controller/PartnerController.java

```java
/**
 * 此方法用于：重制合作商密码
 *
 * @param id 合作商 Id
 * @return AjaxResult
 */
@PreAuthorize("@ss.hasPermi('manage:partner:edit')")
@Log(title = "合作商管理", businessType = BusinessType.DELETE)
@PutMapping("/resetPwd/{id}")
public AjaxResult resetPwd(@PathVariable Long id) {
    // 创建合作商对象
    Partner partner = new Partner();
    partner.setId(id);
    partner.setPassword(SecurityUtils.encryptPassword("123456"));
    // 调用修改方法修改密码
    return toAjax(partnerService.updatePartner(partner));
}
```

### 11.3.前端改造

添加一个网络请求，用于重置密码：

src/api/manage/partner.js

```js
// 重制密码
export function resetPwd(id) {
  return request({
    url: '/manage/partner/resetPwd/' + id,
    method: 'put'
  })
}
```

在前端视图组件中，添加一个“重置密码”按钮：

src/views/manage/partner/index.vue

```vue
<el-table-column label="操作" align="center" class-name="small-padding fixed-width" width="300px">
  <template #default="scope">
    <el-button
      link
      type="primary"
      @click="handleResetPwd(scope.row)"
      v-hasPermi="['manage:partner:edit']"
      >重置密码</el-button
    >
  </template>
  ……
</el-table-column>

<script>
……

/** 重制密码 */
function handleResetPwd(row) {
  const _id = row.id
  proxy.$modal
    .confirm('您确定重制该合作商的密码吗？')
    .then(() => {
      return resetPwd(_id)
    })
    .then(() => {
      proxy.$modal.msgSuccess('重置成功')
    })
    .catch(() => {})
}

……
</script>
```

- `<el-table-column>` 标签上的 `width="300px"` 属性，用于增加列的宽度。
