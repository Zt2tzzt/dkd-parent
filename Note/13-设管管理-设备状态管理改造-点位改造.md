# 设备管理之设备状态管理改造、点位改造

因为设备管理和设备状态管理，共用同一套后端代码。导致若依没有生成设备状态管理的前端页面。

需求：为设备状态管理创建前端页面，并在 Vue 中定义响应的路由和菜单项。然后基于原型，完成视图组件基础布局展示改造。

## 一、设备状态管理改造

### 1.1.前端改造（一）

在前端工程中，创建 `vmStatus` 包，路径如下。

src/views/manage/vmStatus

将 `vm` 包下的 `index.vue` 组件，复制到改目录下。

src/views/manage/vmStatus/index.vue

### 1.2.菜单创建

Ⅰ、左侧菜单 -> 系统管理 -> 菜单管理；

Ⅱ、点击”新增“按钮，弹出会话框；

- “上级菜单”，选择“`设备管理`”；
- “菜单类型”，选择“`菜单`”，表示是页面菜单（二级菜单）。
- “菜单图标”，选择一个图标；
- “菜单名称”，填写“`设备状态`”；
- “显示排序”，填写“`2`”；
- “是否外链”，表示当前目录是内部路由还是外部链接，这里选“否”；
- “路由地址”，非常重要，是页面组件之间的跳转方式，这里填“`vmStatus`”
- "组件路径"，填写“`manage/vmStatus/index`”。
- “权限字符”、填写“`manage:vm:list`”（参考设备管理的列表查询权限）
- “显示状态”、“菜单状态”维持默认值。
- 点击确定。

Ⅲ、刷新页面，发现“设备状态”目录，已显示在左侧菜单。

### 1.3.前端改造（二）

#### 1.3.1.搜索框改造

去掉“新增”、”修改“、“删除”、“导出”按钮。

src/views/manage/vmStatus/index.vue

```vue
<el-row :gutter="10" class="mb8">
  <right-toolbar v-model:showSearch="showSearch" @queryTable="getList"></right-toolbar>
</el-row>
```

#### 1.3.2.列表视图改造

去掉批量操作的复选框。

“设备状态”，改为“运营状态”，并根据 `runningStatus` 的值进行判断。

src/views/manage/vmStatus/index.vue

```vue
<el-table-column label="运营状态" align="center" prop="vmStatus">
  <template #default="scope">
    <!-- <dict-tag :options="vm_status" :value="scope.row.vmStatus" /> -->
    {{ scope.row.runningStatus ? (JSON.parse(scope.row.runningStatus).status ? '正常' : '异常') : '异常' }}
  </template>
</el-table-column>
```

“操作”列的按钮，由“修改”改为“查看详情”。

```vue
<template>
  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button
        link
        type="primary"
        @click="handleVmInfo(scope.row)"
        v-hasPermi="['manage:vm:query']"
        >查看详情</el-button
      >
    </template>

    <!-- 查看详情 -->
    <el-dialog :title="title" v-model="open" width="500px" append-to-body> </el-dialog>
  </el-table-column>
</template>

<script>
/** 查看详情操作 */
const handleVmInfo = row => {
  const _id = row.id

  open.value = true
  title.value = '设备详情'
}
</script>
```

后面的模块中，再将设备详情页中的内容进行完善。

## 二、点位改造

在点位管理的列表视图最后的“操作”列，新增一个“查看详情”的按钮。

点击该按钮，展示点位下的设备列表。

- ”查看详情“按钮的权限是 `manage:vm:list`。
- 新增一个函数 `handleVmInfo` 用于处理点击“查看详情”的事件。
- 新增一个 `<el-dialog>` 用于展示查看详情对话框。

src/views/manage/node/index.vue

```vue
<template>
  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button
        link
        type="primary"
        @click="handleVmInfo(scope.row)"
        v-hasPermi="['manage:vm:list']"
        >查看详情</el-button
      >
      ……
    </template>
  </el-table-column>

    <!-- 查看详情对话框 -->
    <el-dialog title="vmInfoTitle" v-model="vmInfoOpen" width="750px" append-to-body>
      <el-table :data="vmList">
        <el-table-column label="序号" type="index" align="center" width="50" />
        <el-table-column label="设备编号" align="center" prop="innerCode" />
        <el-table-column label="详细地址" align="center" prop="addr" show-overflow-tooltip />
        <el-table-column label="设备状态" align="center" prop="vmStatus">
          <template #default="scope">
            <dict-tag :options="vm_status" :value="scope.row.vmStatus" />
          </template>
        </el-table-column>
        <el-table-column label="最后一次供货时间" align="center" prop="lastSupplyTime">
          <template #default="scope">
            {{ parseTime(scope.row.lastSupplyTime) }}
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>
</template>

<script>
import { listVm } from '@/api/manage/vm'
……
const { vm_status } = proxy.useDict('vm_status')

/** 查看详情按钮操作 */
const vmList = ref([])
const vmInfoOpen = ref(false)
const vmInfoTitle = ref('')
const handleVmInfo = row => {
  const _id = row.id
  const param = { ...loadAllParams, nodeId: _id }
  listVm(param).then(res => {
    vmList.value = res.rows
    vmInfoOpen.value = true
    vmInfoTitle.value = '点位详情'
  })
}

</script>
```

- `vm_status` 是预加载的数据字典，要使用钩子函数 `useDict` 获取。
