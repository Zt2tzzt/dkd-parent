# 点位管理之区域管理、点位管理、合作商管理的改造

## 一、区域管理改造

### 1.1.主键 id label 改造

在列表视图页面，将”主键 id“的 label 改为“序号”，并提供排序的功能。

```vue
<el-table-column label="序号" type="index" width="50" align="center" prop="id" />
```

- `type="index"` 用于设置排序共嗯。
- `width="50"` 用于增加列的宽度。

### 1.2.操作列图标移除

```vue
<el-button link type="primary" icon="Edit" @click="handleUpdate(scope.row)" v-hasPermi="['manage:region:edit']">修改</el-button>
<el-button link type="primary" icon="Delete" @click="handleDelete(scope.row)" v-hasPermi="['manage:region:remove']">删除</el-button>

<!-- 改为 👇 -->

<el-button link type="primary" @click="handleUpdate(scope.row)" v-hasPermi="['manage:region:edit']">修改</el-button>
<el-button link type="primary" @click="handleDelete(scope.row)" v-hasPermi="['manage:region:remove']">删除</el-button>
```

- 去掉了 `icon="xxx"` 属性。

### 1.3.增加“点位数”列

在区域管理的列表视图中，增加“点位数”列。

接口信息如下：

**Path：** /manage/region/list

**Method：** GET

接口描述：

请求参数

Query

| 参数名称 | 是否必须 | 示例   | 备注     |
| -------- | -------- | ------ | -------- |
| pageNum  | 是       | 1      | 当前页   |
| pageSize | 是       | 10     | 每页个数 |
| name     | 否       | 海淀区 | 区域名称 |

返回数据

| 名称         | 类型      | 是否必须 | 默认值 | 备注     | 其他信息          |
| ------------ | --------- | -------- | ------ | -------- | ----------------- |
| total        | number    | 必须     |        |          | mock: 3           |
| rows         | object [] | 必须     |        |          | item 类型: object |
| ├─ remark    | string    | 必须     |        | 备注说明 |                   |
| ├─ id        | number    | 必须     |        | 区域ID   |                   |
| ├─ name      | string    | 必须     |        | 区域名称 |                   |
| ├─ nodeCount | number    | 必须     |        | 点位数量 |                   |
| code         | number    | 必须     |        |          | mock: 200         |
| msg          | string    | 必须     |        |          | mock: 查询成功    |

- 其中包含了 `nodeCount` 字段，标识“点位数”。

实现上方接口返回的方案有：

**（1）同步存储：**在区域表 `region` 中，存储点位数的字段，当点位发生变化时，同步区域表中的点位数。

- 优点：由于是单表查询操作，查询列表效率最高。
- 缺点：需要在点位增、删、改时，修改区域表中的字段值，有额外的开销，数据也可能不一致。

**（2）关联查询：**编写关联查询语句，在 mapper 层封装。

- 优点：实时查询，数据 100% 正确，不需要单独维护。
- 缺点：SQL 语句较复杂，如果数据量大，性能比较低。

区域和点位表，记录个数都不是很多，所以我们采用关联查询这种方案。

![区域表与点位表的关系](NodeAssets/区域表与点位表的关系.png)

#### 1.3.1.SQL 编写

传统方式：

```mysql
-- 1.先聚合统计每个区域下的点位
SELECT region_id, COUNT(*) node_count
FROM node
GROUP BY region_id;

-- 2.然后与区域表进行关联查询
SELECT r.name, r.remark, n.node_count
FROM region r
         LEFT JOIN (SELECT region_id, COUNT(*) node_count FROM node GROUP BY region_id) n
                   ON r.id = n.region_id;

-- 3.使用 MySQL IFNULL 函数，优化 null 值。
SELECT r.name, r.remark, IFNULL(n.node_count, 0) AS node_count
FROM region r
         LEFT JOIN (SELECT region_id, COUNT(*) node_count FROM node GROUP BY region_id) n
                   ON r.id = n.region_id;
```

- `IFNULL` 函数`，用于处理 null 值。

使用 AI 生成：

Prompt 输入：

```markdown
查询区域表所有信息，需要显示每个区域的点位数
```

AIGC 输出：

```mysql
SELECT r.name      AS region_name,
       r.remark,
       COUNT(n.id) AS node_count
FROM region r
         LEFT JOIN
     node n
     ON
         r.id = n.region_id
GROUP BY r.id;
```

#### 1.3.2.后端 VO 类设计

在 domain 包下，创建一个目录 vo，在其中创建 VO 类。

dkd-manage/src/main/java/com/dkd/manage/domain/vo/RegionVO.java

```java
@EqualsAndHashCode(callSuper = true)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RegionVO extends Region {
    // 点位数量
    private Integer nodeCount;
}
```

#### 1.3.3.后端 Mapper 层改造

在 `RegionMapper` 接口中，新增 `selectRegionVOList` 方法。

dkd-manage/src/main/java/com/dkd/manage/mapper/RegionMapper.java

```java
/**
 * 此方法用于：查询区域管理列表
 *
 * @param region 区域管理
 * @return List<RegionVO>
 */
List<RegionVO> selectRegionVOList(Region region);
```

在 XML 映射文件中，处理动态 SQL

dkd-manage/src/main/resources/mapper/manage/RegionMapper.xml

```xml
    <select id="selectRegionVOList" resultType="com.dkd.manage.domain.vo.RegionVO">
        SELECT r.name,
               r.remark,
               COUNT(n.id) AS node_count
        FROM region r
                 LEFT JOIN
             node n
             ON
                 r.id = n.region_id
        <where>
            <if test="name != null  and name != ''"> AND r.name LIKE concat('%', #{name}, '%')</if>
        </where>
        GROUP BY r.id
    </select>
```

注意事项：

- 因为使用了 PageHelper 分页查询，所有 SQL 后面不能有 `;` 号。

- 复制过来的 `<where>` 子标签中，要将表的别名加上；并且要放在 `GROUP BY` 语句的前面。

- `node_count` 字段，要映射到类中的 `nodeCount` 字段，要打开 MyBatis 的驼峰命名转换配置（在若依中默认是关闭的）：

  dkd-admin/src/main/resources/mybatis/mybatis-config.xml

  ```xml
  <!-- 使用驼峰命名法转换字段 -->
  <setting name="mapUnderscoreToCamelCase" value="true"/>
  ```

#### 1.3.4.后端 Service 层改造

在 `IRegionService` 接口中，新增方法 `regionVoList`。

dkd-manage/src/main/java/com/dkd/manage/service/.java

```java
/**
 * 此方法用于：查询区域管理列表
 *
 * @param region 区域管理
 * @return List<RegionVO>
 */
List<RegionVO> regionVoList(Region region);
```

在 `RegionServiceImpl` 实现类中，实现 `regionVoList` 方法。

dkd-manage/src/main/java/com/dkd/manage/service/impl/RegionServiceImpl.java

```java
/**
 * 此方法用于：查询区域管理列表
 *
 * @param region 区域管理
 * @return List<RegionVO>
 */
@Override
public List<RegionVO> regionVoList(Region region) {
    return regionMapper.selectRegionVOList(region);
}
```

#### 1.3.5.后端 Controller 层改在

`RegionController` 控制器类中的 `list` 方法改造。

dkd-manage/src/main/java/com/dkd/manage/controller/RegionController.java

```java
/**
 * 查询区域管理列表
 */
@PreAuthorize("@ss.hasPermi('manage:region:list')")
@GetMapping("/list")
public TableDataInfo list(Region region)
{
    startPage();
    List<RegionVO> list = regionService.regionVoList(region);
    return getDataTable(list);
}
```

> 若依的热更新插件
>
> 如果没有新增文件，使用快捷键 Ctrl + F9，就可以完成后端服务热更新。

#### 1.3.6.前端组件修改

在前端页面加入一列，标识点位数。

src/views/manage/region/index.vue

```vue
<el-table-column label="点位数" align="center" prop="nodeCount" />
```

### 1.4.操作列增加“查看详情”

查看详情，需要显示当前区域下所有点位列表（后续完成）

## 二、合作商管理改在

### 2.1.合作商名搜索框 label 宽度改造

若依自动生成的合作商名搜索框 label 宽度太小，导致了自动换行。

src/views/manage/partner/index.vue

```vue
<el-form :model="queryParams" ref="queryRef" :inline="true" v-show="showSearch" label-width="90px">
  <el-form-item label="合作商名称" prop="name">
    <el-input
      v-model="queryParams.name"
      placeholder="请输入合作商名称"
      clearable
      @keyup.enter="handleQuery"
    />
  </el-form-item>
  <el-form-item>
    <el-button type="primary" icon="Search" @click="handleQuery">搜索</el-button>
    <el-button icon="Refresh" @click="resetQuery">重置</el-button>
  </el-form-item>
</el-form>
```

- 修改了 `label-width="90px"`。

### 2.1.主键 id label 改造

在列表视图页面，将”主键 id“的 label 改为“序号”，并提供排序的功能。

src/views/manage/partner/index.vue

```vue
<el-table-column label="序号" type="index" align="center" prop="id" />
```

- `type="index"` 用于设置排序共嗯。
- `width="50"` 用于增加列的宽度。

### 2.2.联系人、联系电话例改造

将联系人、联系电话列调整到最后。

src/views/manage/partner/index.vue

```vue
<el-table-column type="selection" width="55" align="center" />
<el-table-column label="序号" type="index" align="center" prop="id" />
<el-table-column label="合作商名称" align="center" prop="name" />
<el-table-column label="账号" align="center" prop="account" />
<el-table-column label="分成比例" align="center" prop="profitShare" />
<!-- <el-table-column label="密码" align="center" prop="password" /> -->
<el-table-column label="联系人" align="center" prop="contactPerson" />
<el-table-column label="联系电话" align="center" prop="contactPhone" />
<el-table-column label="操作" align="center" class-name="small-padding fixed-width">
```

### 2.3.分成比例列改造

分成比例列，值后方加上百分号。

src/views/manage/partner/index.vue

```vue
<el-table-column label="分成比例" align="center">
  <template #default="scope">
    {{ scope.row.profitShare }}%
  </template>
</el-table-column>
```

### 2.4.操作列图标移除

```vue
<el-button link type="primary" icon="Edit" @click="handleUpdate(scope.row)" v-hasPermi="['manage:region:edit']">修改</el-button>
<el-button link type="primary" icon="Delete" @click="handleDelete(scope.row)" v-hasPermi="['manage:region:remove']">删除</el-button>

<!-- 改为 👇 -->

<el-button link type="primary" @click="handleUpdate(scope.row)" v-hasPermi="['manage:partner:edit']">修改</el-button>
<el-button link type="primary" @click="handleDelete(scope.row)" v-hasPermi="['manage:partner:remove']">删除</el-button>
```

- 去掉了 `icon="xxx"` 属性。

### 2.5.添加/修改合作商页面改造

#### 2.5.1.密码使用掩码

src/views/manage/partner/index.vue

```vue
<el-form-item label="密码" prop="password">
  <el-input v-model="form.password" type="password" placeholder="请输入密码" />
</el-form-item>
```

- 增加 `type="password"` 属性。

#### 2.5.2.合作商名称 label 宽度

src/views/manage/partner/index.vue

```vue
<el-form ref="partnerRef" :model="form" :rules="rules" label-width="100px">
  ……
</el-form>
```

- 修改了 `label-width="100px"` 属性。

### 2.6.修改合作商页面改造

修改合作商页面，没有账号、密码字段；并且要展示合作商的创建时间。

思路：修改操作，因为会回显数据记录，所以使用记录 id 的。

```vue
<el-form-item label="创建时间" prop="createTime" v-if="form.id">
  {{ form.createTime }}
</el-form-item>
<el-form-item label="账号" prop="account" v-if="!form.id">
  <el-input v-model="form.account" placeholder="请输入账号" />
</el-form-item>
<el-form-item label="密码" prop="password" v-if="!form.id">
  <el-input v-model="form.password" type="password" placeholder="请输入密码" />
</el-form-item>
```

- 使用 `v-if` 判断 `form.id` 是否有值，有则是修改页面；否则是添加页面。

### 2.7.密码加密

合作商的密码明文存储在数据库，安全性低。

使用若依集成的 Spring Security，进行密码加密处理。

在 `PartnerServiceImpl` 实现类中，改造 `insertPartner` 方法。

dkd-manage/src/main/java/com/dkd/manage/service/impl/PartnerServiceImpl.java

```java
/**
 * 新增合作商管理
 *
 * @param partner 合作商管理
 * @return 结果
 */
@Override
public int insertPartner(Partner partner)
{
    // 使用 Spring Security 对密码进行加密处理
    partner.setPassword(SecurityUtils.encryptPassword(partner.getPassword()));
    partner.setCreateTime(DateUtils.getNowDate());
    return partnerMapper.insertPartner(partner);
}
```

### 2.8.查看详情改造

在列表视图的“操作”列，添加”查看详情“的按钮。

```vue
<template>
  <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button
        link
        type="primary"
        @click="handleDetail(scope.row)"
        v-hasPermi="['manage:partner:query']"
        >查看详情</el-button
      >
    </template>
    ……
  </el-table-column>

……

  <!-- 查看详情对话框 -->
  <el-dialog title="合作商详情" v-model="detailInfoOpen" width="500px" append-to-body>
    <el-row>
      <el-col :span="12">合作商名称：{{ form.name }}</el-col>
      <el-col :span="12">联系人：{{ form.contactPerson }}</el-col>
    </el-row>
    <el-row>
      <el-col :span="12">联系电话：{{ form.contactPhone }}</el-col>
      <el-col :span="12">联系人：{{ form.profitShare }}%</el-col>
    </el-row>
  </el-dialog>
</template>

<script>
……

const detailInfoOpen = ref(false)
/** 查看详情按钮操作 */
const handleDetail = row => {
  reset()
  const _id = row.id || ids.value
  getPartner(_id).then(res => {
    form.value = res.data
    detailInfoOpen.value = true
  })
}

</script>
```

- `manage:partner:query` 表示查询权限。
- `handleDetail` 是新增的方法，用来展示对话框。
- `detailInfoOpen` 状态，用来表示对话框的开启、关闭。

新增的对话框页面不是很美观，使用 AIGC 优化：

Prompt 提示工程输入：

```markdown
你是一个软件工程师，帮我优化下方代码中对话框中的布局
<!-- 查看详情对话框 -->
<el-dialog title="合作商详情" v-model="detailInfoOpen" width="500px" append-to-body>
  <el-row>
    <el-col :span="12">合作商名称：{{ form.name }}</el-col>
    <el-col :span="12">联系人：{{ form.contactPerson }}</el-col>
  </el-row>
  <el-row>
    <el-col :span="12">联系电话：{{ form.contactPhone }}</el-col>
    <el-col :span="12">联系人：{{ form.profitShare }}%</el-col>
  </el-row>
</el-dialog>
```

AIGC 输出

```vue
<!-- 查看详情对话框 -->
<el-dialog
  title="合作商详情"
  v-model="detailInfoOpen"
  width="500px"
  append-to-body
>
  <!-- 使用更清晰的布局 -->
  <el-row :gutter="20" class="dialog-content">
    <el-col :span="12">
      <strong>合作商名称：</strong> {{ form.name }}
    </el-col>
    <el-col :span="12">
      <strong>联系人：</strong> {{ form.contactPerson }}
    </el-col>
  </el-row>
  <el-row :gutter="20" class="dialog-content">
    <el-col :span="12">
      <strong>联系电话：</strong> {{ form.contactPhone }}
    </el-col>
    <el-col :span="12">
      <strong>分润比例：</strong> {{ form.profitShare }}%
    </el-col>
  </el-row>
</el-dialog>

<style scoped>
.dialog-content {
  margin-bottom: 10px; /* 添加下方间距 */
  font-size: 14px;     /* 提高可读性 */
  line-height: 1.6;    /* 增加行高 */
}
</style>
```

### 2.9.增加“点位数”列

在合作商管理的列表视图中，增加“点位数”列。

参考上文【1.3.增加“点位数”列】进行实现。
