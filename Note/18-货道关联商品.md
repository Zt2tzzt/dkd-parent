# 货道关联商品

需求：对智能售货机内部的货道，进行商品摆放的管理。效果图如下所示：

![货道关联商品效果图](/Users/zetian/workshop/project/dkd-parent/Note/NodeAssets/货道关联商品效果图.png)

此功能涉及四个后端接口

- 查询设备类型（已完成）
- 查询货道列表
- 查询商品列表（已完成）
- 货道关联商品

## 一、前端代码导入

① 从资料中，复制货道 api 请求 js 文件，到 api/manage 目录下

src/api/manage/channel2.js

② 从资料中，复制货道的视图组件，到 views/manage/vm 目录下

src/views/manage/vm/components

③ 修改设备 index.vue

src/views/manage/vm/index.vue

```vue
<template>
  ……

  <!-- 货道组件 -->
  <ChannelDialog
    :goodVisible="goodVisible"
    :goodData="goodData"
    @handleCloseGood="handleCloseGood"
  ></ChannelDialog>
</template>

<script>
import ChannelDialog from './components/ChannelDialog.vue'
……
// ********************货道********************
// 货道组件
const goodVisible = ref(false) //货道弹层显示隐藏
const goodData = ref({}) //货道信息用来拿取 vmTypeId和innerCode
// 打开货道弹层
const handleGoods = row => {
  goodVisible.value = true
  goodData.value = row
}
// 关闭货道弹层
const handleCloseGood = () => {
  goodVisible.value = false
}
// ********************货道end********************
</script>

```

## 二、查询货道列表-接口文档

根据售货机编号查询货道列表

基本信息

**Path：** /manage/channel/list/:innerCode

**Method：** GET

请求路径参数：

| 参数名称  | 示例     | 备注     |
| --------- | -------- | -------- |
| innerCode | A1000001 | 设备编号 |

返回数据

| 名称               | 类型      | 是否必须 | 默认值 | 备注     | 其他信息          |
| ------------------ | --------- | -------- | ------ | -------- | ----------------- |
| msg                | string    | 必须     |        | 返回内容 | mock: 操作成功    |
| code               | number    | 必须     |        | 状态码   | mock: 200         |
| data               | object [] | 必须     |        |          | item 类型: object |
| ├─ id              | number    | 必须     |        | 货道ID   |                   |
| ├─ channelCode     | string    | 必须     |        | 货道编号 |                   |
| ├─ skuId           | number    | 必须     |        | 商品ID   |                   |
| ├─ innerCode       | string    | 必须     |        | 设备编号 |                   |
| ├─ maxCapacity     | number    | 必须     |        | 最大容量 |                   |
| ├─ currentCapacity | number    | 必须     |        | 当前容量 |                   |
| ├─ sku             | object    | 必须     |        | 商品     |                   |
| ├─ skuId           | number    | 非必须   |        | 商品ID   |                   |
| ├─ skuName         | string    | 非必须   |        | 商品名称 |                   |
| ├─ skuImage        | string    | 非必须   |        | 商品图片 |                   |

## 三、查询货道列表-后端改造

### 2.1.Channel VO 类准备

ChannelVO 类

dkd-manage/src/main/java/com/dkd/manage/domain/vo/ChannelVO.java

```java
package com.dkd.manage.domain.vo;

import com.dkd.manage.domain.Channel;
import com.dkd.manage.domain.Sku;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ChannelVO extends Channel {
    private Sku sku;
}
```

### 2.2.Channel Mapper 层改造

dkd-manage/src/main/java/com/dkd/manage/mapper/ChannelMapper.java

```java
/**
 * 根据售货机编号，查询货道列表
 *
 * @param innerCode 售货机编号
 * @return List<ChannelVO>
 */
List<ChannelVO> selectChannelVOListByInnerCode(String innerCode);
```

dkd-manage/src/main/resources/mapper/manage/ChannelMapper.xml

```xml
<resultMap type="ChannelVO" id="ChannelVOResult">
    <result property="id" column="id"/>
    <result property="channelCode" column="channel_code"/>
    <result property="skuId" column="sku_id"/>
    <result property="vmId" column="vm_id"/>
    <result property="innerCode" column="inner_code"/>
    <result property="maxCapacity" column="max_capacity"/>
    <result property="currentCapacity" column="current_capacity"/>
    <result property="lastSupplyTime" column="last_supply_time"/>
    <result property="createTime" column="create_time"/>
    <result property="updateTime" column="update_time"/>
    <association property="sku" javaType="Sku" column="sku_id"
                 select="com.dkd.manage.mapper.SkuMapper.selectSkuBySkuId"/>
</resultMap>

<select id="selectChannelVOListByInnerCode" resultType="com.dkd.manage.domain.vo.ChannelVO">
    <include refid="selectChannelVo"/>
    WHERE inner_code = #{innerCode}
</select>
```

`<association>` 标签的：

- `property` 属性，对应 `NodeVO` 类中的属性名；
- `javaType` 属性，对应该属性的 Java 实体类型。
- `column`  属性，表示查询的列名。
- `select` 属性，表示将查询的列的值，传入一个方法的全限定名，将 `column` 对应的值，传入该方法的型参中。

### 2.3.Channel Service 层改造

dkd-manage/src/main/java/com/dkd/manage/service/IChannelService.java

```java
/**
 * 根据售货机编号，查询货道列表
 *
 * @param innerCode 售货机编号
 * @return List<ChannelVO>
 */
List<ChannelVO> selectChannelVOListByInnerCode(String innerCode);
```

dkd-manage/src/main/java/com/dkd/manage/service/impl/ChannelServiceImpl.java

```java
/**
 * 根据售货机编号，查询货道列表
 *
 * @param innerCode 售货机编号
 * @return List<ChannelVO>
 */
@Override
public List<ChannelVO> selectChannelVOListByInnerCode(String innerCode) {
    return channelMapper.selectChannelVOListByInnerCode(innerCode);
}
```

### 2.4.Channel Controller 层改造

dkd-manage/src/main/java/com/dkd/manage/controller/ChannelController.java

```java
/**
 * 根据售货机软编号获取货道列表
 */
@PreAuthorize("@ss.hasPermi('manage:channel:list')")
@GetMapping("/list/{innerCode}")
public AjaxResult getChannelVOListByInnerCode(@PathVariable String innerCode) {
    List<ChannelVO> channelVOList = channelService.selectChannelVOListByInnerCode(innerCode);
    return success(channelVOList);
}
```

## 四、货道关联商品-接口文档

货道关联商品

基本信息

**Path：** /manage/channel/config

**Method：** PUT

请求参数

Headers

| 参数名称     | 参数值           | 是否必须 | 示例 | 备注 |
| ------------ | ---------------- | -------- | ---- | ---- |
| Content-Type | application/json | 是       |      |      |

Body

| 名称           | 类型      | 是否必须 | 默认值 | 备注         | 其他信息          |
| -------------- | --------- | -------- | ------ | ------------ | ----------------- |
| innerCode      | string    | 必须     |        | 设备号       |                   |
| channelList    | object [] | 必须     |        | 货道配置集合 | item 类型: object |
| ├─ innerCode   | string    | 必须     |        | 设备编号     |                   |
| ├─ channelCode | string    | 必须     |        | 货道编号     |                   |
| ├─ skuId       | number    | 必须     |        | 商品ID       |                   |

返回数据

| 名称 | 类型   | 是否必须 | 默认值 | 备注 | 其他信息       |
| ---- | ------ | -------- | ------ | ---- | -------------- |
| msg  | string | 必须     |        |      | mock: 操作成功 |
| code | number | 必须     |        |      | mock: 200      |

## 五、货道关联商品=后端改造

### 5.1.Channel DTO 类准备

创建 DTO 类，接受前端传递过来的数据

`ChannelSkuDTO` 类

 dkd-manage/src/main/java/com/dkd/manage/domain/dto/ChannelSkuDTO.java

```java
package com.dkd.manage.domain.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ChannelSkuDTO {
    private String innerCode; // 售货机编号
    private String channelCode; // 货道编号
    private Long skuId; // 商品ID
}
```

`ChannelConfigDTO` 类

dkd-manage/src/main/java/com/dkd/manage/domain/dto/ChannelConfigDTO.java

```java
package com.dkd.manage.domain.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ChannelConfigDTO {
    private String innerCode;
    private List<ChannelSkuDTO> channelList;
}
```

### 5.2.Channel Mapper 层改造

在 Mapper 层，新增两个方法，分别用于查询货道信息，批量修改货道信息。

> 逻辑分析顺序：Controller -> Service -> Mapper
>
> 代码开发顺序：Mapper -> Service -> Controller

`ChannelMapper` 接口

dkd-manage/src/main/java/com/dkd/manage/mapper/ChannelMapper.java

```java
/**
 * 根据售货机编号和货道编号查询货道信息
 *
 * @param innerCode 售货机编号
 * @param channelCode 货道编号
 * @return Channel
 */
@Select("SELECT id, channel_code, sku_id, vm_id, inner_code, max_capacity, current_capacity, last_supply_time, create_time, update_time FROM channel WHERE inner_code = #{innerCode} AND channel_code = #{channelCode}")
Channel selectChannelByInnerCodeAndChannelCode(@Param("innerCode") String innerCode, @Param("channelCode") String channelCode);

/**
 * 批量修改货道信息
 * 
 * @param channelList 货道集合
 * @return int
 */
int updateChannelsBatch(List<Channel> channelList);
```

使用 AIGC 的方式，根据已有的 UPDATE 语句，生成如下 xml 语句。

`ChannelMapper` 映射文件

dkd-manage/src/main/resources/mapper/manage/ChannelMapper.xml

```xml
<update id="updateChannelsBatch" parameterType="java.util.List">
    <foreach collection="list" item="channel" separator=";">
        UPDATE channel
        <trim prefix="SET" suffixOverrides=",">
            <if test="channel.channelCode != null and channel.channelCode != ''">channel_code = #{channel.channelCode},</if>
            <if test="channel.skuId != null">sku_id = #{channel.skuId},</if>
            <if test="channel.vmId != null">vm_id = #{channel.vmId},</if>
            <if test="channel.innerCode != null and channel.innerCode != ''">inner_code = #{channel.innerCode},</if>
            <if test="channel.maxCapacity != null">max_capacity = #{channel.maxCapacity},</if>
            <if test="channel.currentCapacity != null">current_capacity = #{channel.currentCapacity},</if>
            <if test="channel.lastSupplyTime != null">last_supply_time = #{channel.lastSupplyTime},</if>
            <if test="channel.createTime != null">create_time = #{channel.createTime},</if>
            <if test="channel.updateTime != null">update_time = #{channel.updateTime},</if>
        </trim>
        WHERE id = #{channel.id}
    </foreach>
</update>
```

可见 UPDATE 语句，写在了 `<foreach>` 标签里，意味着一次请求可能执行多条 UPDATE 语句。

> MySQL 连接，一次请求默认只支持单条 sql 的执行，如果要运行多条 sql 的执行，要加入一个参数 `allowMultiQueries=true`
>
> ```yaml
> # 数据源配置
> spring:
>     datasource:
>         druid:
>             # 主库数据源
>             master:
>                 url: jdbc:mysql://xxx.xxx.xxx.xxx:3306/dkd?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8&allowMultiQueries=true
> ```

### 5.3.Channel Service 层改造

IChannelService 接口

dkd-manage/src/main/java/com/dkd/manage/service/IChannelService.java

```java
/**
 * 设置货道关联商品
 *
 * @param channelConfigDTO 货道配置信息
 * @return int
 */
int setChannels(ChannelConfigDTO channelConfigDTO);
```

`ChannelServiceImpl` 实现类

dkd-manage/src/main/java/com/dkd/manage/service/impl/ChannelServiceImpl.java

```java
/**
 * 设置货道关联商品
 *
 * @param channelConfigDTO 货道配置信息
 * @return int
 */
@Override
public int setChannels(ChannelConfigDTO channelConfigDTO) {
    // 将 dto 转为 po 对象
    List<ChannelSkuDTO> channeVOlList = channelConfigDTO.getChannelList();

    List<Channel> channelList = channeVOlList.stream().map(dto -> {
        // 根据售货机编号，货道编号查询货道信息
        Channel channel = channelMapper.selectChannelByInnerCodeAndChannelCode(dto.getInnerCode(), dto.getChannelCode());
        if (channel == null) return null;
        channel.setSkuId(dto.getSkuId()); // 关联最新商品 id
        channel.setUpdateTime(DateUtils.getNowDate()); // 更新修改时间
        return channel;
    }).collect(Collectors.toList());

    // 修改货道
    return channelMapper.updateChannelsBatch(channelList);
}
```

### 5.4.Channel Controller 层改造

`ChannelController` 控制器类

dkd-manage/src/main/java/com/dkd/manage/controller/ChannelController.java

```java
/**
 * 货道关联商品
 */
@PreAuthorize("@ss.hasPermi('manage:channel:edit')")
@Log(title = "货道关联商品", businessType = BusinessType.UPDATE)
@PutMapping("/config")
public AjaxResult setChannels(@RequestBody ChannelConfigDTO channelConfigDTO) {
    return toAjax(channelService.setChannels(channelConfigDTO));
}
```
