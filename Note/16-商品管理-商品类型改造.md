# 商品管理之商品类型改造、商品管理改造

## 一、商品类型改造

### 1.1.添加、修改逻辑改造

在数据库中，商品类型的名称，有唯一约束。

添加一段异常处理的逻辑，用于处理添加、修改商品类型，名称重复的异常。

dkd-framework/src/main/java/com/dkd/framework/web/exception/GlobalExceptionHandler.java

```java
/**
 * 此方法用于：处理数据完整性异常
 */
@ExceptionHandler(DataIntegrityViolationException.class)
public AjaxResult handleDataIntegrityViolationException(DataIntegrityViolationException e) {
    log.error("数据完整性异常", e);

    String errMsg = e.getMessage();
    if (errMsg.contains("foreign key"))
        return AjaxResult.error("无法删除，有其它数据引用");

    if (errMsg.contains("emp.user_mobile_uindex"))
        return AjaxResult.error("员工手机号已存在");

    if (errMsg.contains("Duplicate"))
        return AjaxResult.error("无法保存，名称已存在");


    return AjaxResult.error("数据完整性异常，请检查数据是否完整");
}
```

## 二、商品管理改造

### 2.1.列表视图改造

#### 2.1.1.商品价格改造

商品价格，在数据库中使用整型，存储单位为“分”的数值。

在前端，要处理成单位为元的形式，进行展示。

src/views/manage/sku/index.vue

 ```vue
 <el-table-column label="商品价格" align="center" prop="price">
   <template #default="scope">
     <el-tag> {{ scope.row.price / 100 }} 元 </el-tag>
   </template>
 </el-table-column>
 ```

- 使用 `<el-tag>` 增强阅读性。

#### 2.1.2.商品类型改造

商品类型 id，转为商品类型名称。

- 采用获取所有商品类型列表，再在前端遍历的方案。
- 这么做的好处是减轻了后端数据库的负担，并能利用前端浏览器的渲染能力。

```vue
<template>
  <el-table-column label="商品类型" align="center" prop="classId" #default="scope">
    <template v-for="item of skuClassOptions" :key="item.classId">
      <div v-if="item.classId === scope.row.classId">{{ item.className }}</div>
    </template>
  </el-table-column>
</template>

<script>
import { listSkuClass } from '@/api/manage/skuClass'
import { loadAllParams } from '@/api/page'
  
……

/** 查询商品类型列表 */
const skuClassOptions = ref([])
const fetchSkuClassList = () => {
  listSkuClass(loadAllParams).then(res => {
    skuClassOptions.value = res.rows
  })
}

fetchSkuClassList()
</script>
```

### 2.2.添加对话框改造

#### 2.2.1.商品价格改造

将“商品价格”改为数字文本框。并设置最小值，最大值，步进，精度。

src/views/manage/sku/index.vue

```vue
<el-form-item label="商品价格" prop="price">
  <el-input-number
    v-model="form.price"
    :min="0.01"
    :max="999.99"
    :precision="2"
    :step="0.5"
    placeholder="请输入商品价格"
  />
</el-form-item>
```

#### 2.2.2.商品类型改造

将“商品类型”改为下拉列表。

因为上文已经加入了查询全部商品类型列表的逻辑，所以这里直接使用 `<el-selection>` 进行展示。

src/views/manage/sku/index.vue

```vue
<el-form-item label="商品类型" prop="classId">
  <!-- <el-input v-model="form.classId" placeholder="请输入商品类型" /> -->
  <el-select v-model="form.classId" placeholder="请选择商品类型">
    <el-option
      v-for="item of skuClassOptions"
      :key="item.classId"
      :label="item.className"
      :value="item.classId"
    />
  </el-select>
</el-form-item>
```

### 2.3..修改对话框改造

#### 2.3.1.商品价格改造

因为数据库中是以“分”为单位，存储的商品价格。所以在修改商品时，要对回显的数据进行处理。

```vue
<script>
……
/** 修改按钮操作 */
function handleUpdate(row) {
  reset()
  const _skuId = row.skuId || ids.value
  getSku(_skuId).then(response => {
    form.value = response.data
    form.value.price /= 100 // 转换单位
    open.value = true
    title.value = '修改商品管理'
  })
}
……
</script>
```

### 2.4.添加、修改逻辑改造

#### 2.4.1.商品价格改造

在添加、修改记录时，“商品价格”要 ✖️100，表示以“分”作为单位。

```vue
<script>
……
/** 提交按钮 */
function submitForm() {
  proxy.$refs['skuRef'].validate(valid => {
    if (valid) {
      // 将商品价格转换为“分”的单位
      form.value.price *= 100
      if (form.value.skuId != null) {
        updateSku(form.value).then(response => {
          proxy.$modal.msgSuccess('修改成功')
          open.value = false
          getList()
        })
      } else {
        addSku(form.value).then(response => {
          proxy.$modal.msgSuccess('新增成功')
          open.value = false
          getList()
        })
      }
    }
  })
}
……
</script>
```

### 2.5.商品删除逻辑改造

在删除商品时，需要判断此商品是否被售货机的货道关联，如果关联则无法删除。

这里货道表，使用逻辑外键约束，来关联商品表；原因是：

- 在新增售货机货道记录时，暂不能指定商品；货道表中的 `sku_id` 有默认值 `0`，而这个值，在商品表中并不存在，
- 那么物理外键约束，会阻止货道表的记录插入，因为 `0` 并不指向任何有效的商品记录。

> 物理外键约束：通过在子表中，添加一个外键列和约束，将该列与父表的主键列相关联，由数据库维护数据的一致性和完整性。
>
> 逻辑外键约束：在不使用数据库外键约束的情况下，通常在应用程序中，通过代码来检查和维护数据的一致性和完整性。

#### 2.5.1.Sku Service 层改造

在 sky 的 Service 层中，加入判断商品 id 集合是否有关联货道的逻辑。

dkd-manage/src/main/java/com/dkd/manage/service/impl/SkuServiceImpl.java

```java
/**
 * 批量删除商品管理
 * 
 * @param skuIds 需要删除的商品管理主键
 * @return 结果
 */
@Override
public int deleteSkuBySkuIds(Long[] skuIds)
{
    // 1.判断商品的 id 集合，是否有关联货道
    if (channelMapper.selectChannelBySKuIds(skuIds) > 0)
        throw new ServiceException("此商品被货道关联，无法删除");

    return skuMapper.deleteSkuBySkuIds(skuIds);
}
```

#### 2.5.2.Channel Mapper 层改造

dkd-manage/src/main/java/com/dkd/manage/mapper/ChannelMapper.java

```java
/**
 * 根据商品 id 查询货道数量
 *
 * @param skuIds 商品 id
 * @return int
 */
int selectChannelBySKuIds(Long[] skuIds);
```

XML 映射文件

dkd-manage/src/main/resources/mapper/manage/ChannelMapper.xml

```xml
<select id="selectChannelBySKuIds" resultType="java.lang.Integer">
    SELECT COUNT(*) FROM channel WHERE sku_id IN
    <foreach collection="array" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</select>
```

- `<foreach>` 的 `collection` 属性，默认固定填写 `array`
