# 商品管理之批量导入

若依生成的代码，默认支持导出功能。

比如商品的导出接口，就在 `SkuClassController` 控制器类中，如下所示：

dkd-manage/src/main/java/com/dkd/manage/controller/SkuClassController.java

```java
/**
 * 导出商品类型列表
 */
@PreAuthorize("@ss.hasPermi('manage:skuClass:export')")
@Log(title = "商品类型", businessType = BusinessType.EXPORT)
@PostMapping("/export")
public void export(HttpServletResponse response, SkuClass skuClass) {
    List<SkuClass> list = skuClassService.selectSkuClassList(skuClass);
    ExcelUtil<SkuClass> util = new ExcelUtil<SkuClass>(SkuClass.class);
    util.exportExcel(response, list, "商品类型数据");
}
```

其中 `ExcelUtil` 工具类中，封装了 apache poi 的相关 API，包括了导出，导入功能。

## 一、批量导入接口文档

### 1.1.基本信息

**Path：** /manage/sku/import

**Method：** POST

### 1.2.请求参数

Headers

| 参数名称          | 参数值                                                                                                                                                                                             | 是否必须 | 示例 | 备注   |
|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------|----|------|
| Content-Type  | multipart/form-data                                                                                                                                                                             | 是    |    |      |
| Authorization | Bearer eyJhbGciOiJIUzUxMiJ9.eyJsb2dpbl91c2VyX2tleSI6ImNlNGU5MWZhLTBhYTItNGZjMy05N2E3LThkNTc0ZjczMGNjNyJ9.m8Ez4tmOb-jxAD9lQYFXQdmXUT-beKbrnu7EdqfFF9CUawkAlQsE5wWCYhqVzIVQn0KqrQa2x2o6my94i5UaDA | 是    |    | 身份令牌 |

Body

| 参数名称 | 参数类型 | 是否必须 | 示例 | 备注        |
|------|------|------|----|-----------|
| file | file | 是    |    | excel上传文件 |

### 1.3.返回数据

| 名称   | 类型     | 是否必须 | 默认值 | 备注   | 其他信息 |
|------|--------|------|-----|------|------|
| msg  | string | 必须   |     | 操作成功 |      |
| code | number | 必须   |     | 200  |      |

## 二、前端改造

使用 Element Plus 提供的[手动上传组件](https://element-plus.org/zh-CN/component/upload.html#手动上传) `<el-upload>`。

src/views/manage/sku/index.vue

```vue
<template>
  <!-- 导入对话框 -->
  <el-dialog title="数据导入" v-model="excelOpen" width="400px" append-to-body>
    <el-upload
        ref="uploadRef"
        class="upload-demo"
        :headers="headers"
        :action="uploadExcelUrl"
        :auto-upload="false"
        :on-success="handleUploadSuccess"
        :on-error="handleUploadError"
        :before-upload="handleBeforeUpload"
        :limit="1"
    >
      <template #trigger>
        <el-button type="primary">选择文件</el-button>
      </template>
      <span style="margin-right: 5px"></span>
      <el-button class="ml-3" type="success" @click="submitUpload">上传</el-button>
      <template #tip>
        <div class="el-upload__tip">上传文件格式仅支持 xls、xlsx，文件大小不得超过1MB</div>
      </template>
    </el-upload>
  </el-dialog>
</template>

<script>
  ……

  // 文件上传前的校验
  const props = defineProps({
    modelValue: [String, Object, Array],
    // 大小限制(MB)
    fileSize: {
      type: Number,
      default: 1
    },
    // 文件类型, 例如['xls', 'xlsx']
    fileType: {
      type: Array,
      default: () => ['xls', 'xlsx']
    }
  })

  /** 导入按钮操作 */
  const excelOpen = ref(false)
  const handleImport = () => {
    excelOpen.value = true
  }

  /** 文件上传 */
  const uploadRef = ref({})
  const uploadExcelUrl = ref(import.meta.env.VITE_APP_BASE_API + '/manage/sku/import') // 上传地址
  const headers = ref({Authorization: 'Bearer ' + getToken()}) // 上传请求头
  const submitUpload = () => {
    uploadRef.value.submit()
  }

  // 上传成功回调
  const handleUploadSuccess = (res, file) => {
    if (res.code === 200) {
      proxy.$modal.msgSuccess('上传成功')
      excelOpen.value = false
      getList()
    } else {
      proxy.$modal.msgError(res.msg)
    }

    uploadRef.value.clearFiles()
    proxy.$modal.closeLoading() // 关闭 loading 层
  }

  // 上传失败回掉
  const handleUploadError = () => {
    proxy.$modal.msgError('上传失败')
    uploadRef.value.clearFiles()
  }

  // 上传前loading加载
  const handleBeforeUpload = file => {
    let isExcel = false
    if (props.fileType.length) {
      let fileExtension = ''
      if (file.name.lastIndexOf('.') > -1) {
        fileExtension = file.name.slice(file.name.lastIndexOf('.') + 1)
      }
      isExcel = props.fileType.some(type => {
        if (file.type.indexOf(type) > -1) return true
        if (fileExtension && fileExtension.indexOf(type) > -1) return true
        return false
      })
    }
    if (!isExcel) {
      proxy.$modal.msgError(`文件格式不正确, 请上传${props.fileType.join('/')}格式文件!`)
      return false
    }
    if (props.fileSize) {
      const isLt = file.size / 1024 / 1024 < props.fileSize
      if (!isLt) {
        proxy.$modal.msgError(`上传Excel图片大小不能超过 ${props.fileSize} MB!`)
        return false
      }
    }
    proxy.$modal.loading('正在上传Excel，请稍候...')
    number.value++
  }

……
</script>
```

- `handleImport` 函数，用于处理“导入”按钮点击事件，打开导入对话框。
- `uploadRef` 对象，用于引用组件的 ref 对象。
- `uploadExcelUrl` 用于表示文件上传接口的 url。
- `headers` 是发送请求要携带的请求头信息。
- `submitUpload` 函数，用于处理“上传”按钮点击事件，将上传的文件发送给后端服务器。
- `handleUploadSuccess`、`handleUploadError` 函数，分别用于处理上传成功、失败的回掉。
- `handleBeforeUpload` 函数，用于处理上传前的文件校验。
- `<el-upload>` 标签的 `limit` 属性，用于限制上传文件的最大数量。

将上传 Excel 的逻辑，抽取成一个组件：

src/components/ExcelUpload/index.vue

```vue
<script setup>
  import {getToken} from '@/utils/auth'

  const {proxy} = getCurrentInstance()

  // 文件上传前的校验
  const props = defineProps({
    url: {
      type: String,
      required: true
    },
    // 大小限制(MB)
    fileSize: {
      type: Number,
      default: 1
    },
    // 文件类型, 例如['xls', 'xlsx']
    fileType: {
      type: Array,
      default: () => ['xls', 'xlsx']
    }
  })

  const emits = defineEmits(['closeDialog'])

  /** 文件上传 */
  const uploadRef = ref(null)
  const uploadExcelUrl = ref(import.meta.env.VITE_APP_BASE_API + props.url) // 上传地址
  const headers = ref({Authorization: 'Bearer ' + getToken()}) // 上传请求头
  const submitUpload = () => uploadRef.value.submit()

  // 上传成功回调
  const handleUploadSuccess = (res, file) => {
    if (res.code === 200) {
      proxy.$modal.msgSuccess('上传成功')
      emits('uploadFinish')
    } else {
      proxy.$modal.msgError(res.msg)
    }

    uploadRef.value.clearFiles()
    proxy.$modal.closeLoading() // 关闭 loading 层
  }

  // 上传失败回掉
  const handleUploadError = () => {
    proxy.$modal.msgError('上传失败')

    uploadRef.value.clearFiles()
    proxy.$modal.closeLoading() // 关闭 loading 层
  }

  // 上传前loading加载
  const handleBeforeUpload = file => {
    let isExcel = false

    if (props.fileType.length) {
      let fileExtension = ''

      if (file.name.lastIndexOf('.') > -1)
        fileExtension = file.name.slice(file.name.lastIndexOf('.') + 1)

      isExcel = props.fileType.some(
          type => file.type.indexOf(type) > -1 || (fileExtension && fileExtension.indexOf(type) > -1)
      )
    }
    if (!isExcel) {
      proxy.$modal.msgError(`文件格式不正确, 请上传${props.fileType.join('/')}格式文件!`)
      return false
    }
    if (props.fileSize) {
      const isLt = file.size / 1024 / 1024 < props.fileSize
      if (!isLt) {
        proxy.$modal.msgError(`上传Excel图片大小不能超过 ${props.fileSize} MB!`)
        return false
      }
    }
    proxy.$modal.loading('正在上传Excel，请稍候...')
  }
</script>

<template>
  <!-- 导入对话框 -->
  <el-upload
      class="upload-demo"
      ref="uploadRef"
      :action="uploadExcelUrl"
      :headers="headers"
      :limit="1"
      :before-upload="handleBeforeUpload"
      :on-success="handleUploadSuccess"
      :on-error="handleUploadError"
      :auto-upload="false"
  >
    <template #trigger>
      <el-button type="primary">选择文件</el-button>
    </template>
    <span style="margin-right: 5px"></span>
    <el-button class="ml-3" type="success" @click="submitUpload">上传</el-button>
    <template #tip>
      <div class="el-upload__tip">上传文件格式仅支持 xls、xlsx，文件大小不得超过1MB</div>
    </template>
  </el-upload>
</template>

<style scoped lang="scss"></style>
```

在 main.js 中，为自定义组件，注册全局组件。

src/main.js

```js
// Excel 导入组件
import ExcelUpload from '@/components/ExcelUpload'

app.component('ExcelUpload', ExcelUpload)
```

在 sku 的页面中，使用自定义组件：

src/views/manage/sku/index.vue

```vue
<template>
  <!-- 导入对话框 -->
  <el-dialog title="数据导入" v-model="excelOpen" width="400px" append-to-body>
    <ExcelUpload url="/manage/sku/import" @uploadFinish="handleUploadFinish"/>
  </el-dialog>
</template>

<script>
  /** 导入按钮操作 */
  const excelOpen = ref(false)
  const handleImport = () => (excelOpen.value = true)
  const handleUploadFinish = () => {
    excelOpen.value = false
    getList()
  }
</script>
```

## 三、后端改造

### 3.1.Controller 层改造

在 `SkuController` 控制器类，加入方法 `excelImport`

dkd-manage/src/main/java/com/dkd/manage/controller/SkuController.java

```java
@PreAuthorize("@ss.hasPermi('manage:sku:add')")
@Log(title = "商品管理", businessType = BusinessType.IMPORT)
@PostMapping("/import")
public AjaxResult excelImport(MultipartFile file) throws IOException {
    ExcelUtil<Sku> util = new ExcelUtil<>(Sku.class);
    List<Sku> skuList = util.importExcel(file.getInputStream());
    return toAjax(skuService.inserSkuBatch(skuList));
}
```

### 3.2.Service 层改造

`ISkuService` 接口

dkd-manage/src/main/java/com/dkd/manage/service/ISkuService.java

```java
/**
 * 此方法用于：批量插入商品
 * @param list 插入的数据
 * @return int
 */
int inserSkuBatch(List<Sku> list);
```

`SkuServiceImpl` 实现类

dkd-manage/src/main/java/com/dkd/manage/service/impl/SkuServiceImpl.java

```java
/**
 * 此方法用于：批量插入商品
 * @param list 插入的数据
 * @return int
 */
@Override
public int inserSkuBatch(List<Sku> list) {
    return skuMapper.insertSkuBatch(list);
}
```

### 3.3.Mapper 层改造

`SkuMapper` 接口

dkd-manage/src/main/java/com/dkd/manage/mapper/SkuMapper.java

```java
/**
 * 此方法用于：批量插入商品
 * @param list 插入的数据
 * @return int
 */
@Override
public int inserSkuBatch(List<Sku> list) {
    return skuMapper.insertSkuBatch(list);
}
```

XML 映射文件

dkd-manage/src/main/resources/mapper/ manage/SkuMapper.xml

```xml

<insert id="insertSkuBatch" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="skuId">
    insert into sku (sku_name, sku_image, brand_Name, unit, price, class_id, is_discount)
    values
    <foreach collection="list" item="sku" separator=",">
        (#{sku.skuName}, #{sku.skuImage}, #{sku.brandName}, #{sku.unit}, #{sku.price}, #{sku.classId},
        #{sku.isDiscount})
    </foreach>
</insert>
```

## 四、Easy Excel

[Easy Excel](https://easyexcel.alibaba.com/) 是阿里巴巴开源的依赖库，用于解析、生成 Excel；

类似的知名框架有 Apache poi、jxl。但它们都存在一个严重的问题，就是非常的耗内存；

poi 有一套 SAX 模式的 API 可以一定程度的解决一些内存溢出的问题，但仍存在一些缺陷：

- 比如：07 版 Excel 解压缩以及解压后存储都是在内存中完成的，内存消耗依然很大。

Easy Excel 重写了 poi 对 07 版 Excel 的解析，

- 一个 3M 的 Excel 用 POI sax 解析依然需要100M 左右内存，改用 Easy Excel 可以降低到几 M；
- 并且再大的 Excel 文件也不会出现内存溢出；依赖 POI 的 sax 模式，在上层做了模型转换的封装，让使用者更加简单方便

参考若依[官网相关文档](https://doc.ruoyi.vip/ruoyi-vue/document/cjjc.html#集成easyexcel实现excel表格增强)，集成 EasyExcel。

### 4.1.引入依赖坐标

在 dkd-common 模块下，引入 Easy Excel 的坐标。

dkd-common/pom.xml

```xml
<!-- Easy Excel-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>easyexcel</artifactId>
    <version>4.0.3</version>
</dependency>
```

### 4.2.ExcelUtil 类增强

在 `ExcelUtil` 类中，新增两个 Easy Excel 相关的方法。

dkd-common/src/main/java/com/dkd/common/utils/poi/ExcelUtil.java

```java
/**
 * 对 excel 表单默认第一个索引名转换成 list（EasyExcel）
 *
 * @param is 输入流
 * @return 转换后集合
 */
public List<T> importEasyExcel(InputStream is) throws Exception {
    return EasyExcel.read(is).head(clazz).sheet().doReadSync();
}

/**
 * 对 list 数据源将其里面的数据导入到 excel 表单（EasyExcel）
 *
 * @param list 导出数据集合
 * @param sheetName 工作表的名称
 * @return 结果
 */
public void exportEasyExcel(HttpServletResponse response, List<T> list, String sheetName) {
    try {
        EasyExcel.write(response.getOutputStream(), clazz).sheet(sheetName).doWrite(list);
    } catch (IOException e) {
        log.error("导出EasyExcel异常{}", e.getMessage());
    }
}
```

### 4.3.Sku 类改造

在 Sku 的实体类的**属性**上，加上 `@ExcelProperty` 注解。

并在该类上，加上其它相应注解。

dkd-manage/src/main/java/com/dkd/manage/domain/Sku.java

```java
/**
 * 商品管理对象 sku
 *
 * @author zetian
 * @date 2024-12-15
 */
@ExcelIgnoreUnannotated // 表示在导出 Excel 时，忽略没有加 @ExcelProperty 注解的字段
@ColumnWidth(16) // 列的宽度
@HeadRowHeight(14) // 表头行的高度
@HeadFontStyle(fontHeightInPoints = 11) // 表头行的字体
public class Sku extends BaseEntity {
    private static final long serialVersionUID = 1L;

    /** 主键 */
    private Long skuId;

    /** 商品名称 */
    @Excel(name = "商品名称")
    @ExcelProperty("商品名称")
    private String skuName;

    /** 商品图片 */
    @Excel(name = "商品图片")
    @ExcelProperty("商品图片")
    private String skuImage;

    /** 品牌 */
    @Excel(name = "品牌")
    @ExcelProperty("品牌")
    private String brandName;

    /** 规格(净含量) */
    @Excel(name = "规格(净含量)")
    @ExcelProperty("规格(净含量)")
    private String unit;

    /** 商品价格，单位分 */
    @Excel(name = "商品价格，单位分")
    @ExcelProperty("商品价格，单位分")
    private Long price;

    /** 商品类型Id */
    @Excel(name = "商品类型Id")
    @ExcelProperty("商品类型Id")
    private Long classId;

    ……
}
```

### 4.4.Sku Controller 改造

改造 Sku Controller 中的导出，导入方法。

dkd-manage/src/main/java/com/dkd/manage/controller/SkuController.java

```java
/**
 * 导出商品管理列表
 */
@PreAuthorize("@ss.hasPermi('manage:sku:export')")
@Log(title = "商品管理", businessType = BusinessType.EXPORT)
@PostMapping("/export")
public void export(HttpServletResponse response, Sku sku) {
    List<Sku> list = skuService.selectSkuList(sku);
    ExcelUtil<Sku> util = new ExcelUtil<Sku>(Sku.class);
    util.exportEasyExcel(response, list, "商品管理数据");
}

@PreAuthorize("@ss.hasPermi('manage:sku:add')")
@Log(title = "商品管理", businessType = BusinessType.IMPORT)
@PostMapping("/import")
public AjaxResult excelImport(MultipartFile file) throws Exception {
    ExcelUtil<Sku> util = new ExcelUtil<>(Sku.class);
    InputStream is = file.getInputStream();
    List<Sku> skuList = util.importEasyExcel(is);
    is.close();
    return toAjax(skuService.inserSkuBatch(skuList));
}
```
