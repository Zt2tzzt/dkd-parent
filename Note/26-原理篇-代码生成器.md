# åŸç†ç¯‡ä¹‹ä»£ç ç”Ÿæˆå™¨

ä»£ç ç”Ÿæˆå™¨ï¼Œæ˜¯æé«˜å¼€å‘æ•ˆç‡çš„é‡è¦å·¥å…·ï¼Œå®ƒä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

ç¬¬ä¸€éƒ¨åˆ†ï¼šå°†ä¸šåŠ¡è¡¨ç»“æ„ï¼Œå¯¼å…¥åˆ°ç³»ç»Ÿä¸­ï¼Œåœ¨è¿™é‡Œï¼Œå¼€å‘è€…å¯ä»¥é¢„è§ˆã€ç¼–è¾‘ã€åˆ é™¤å’ŒåŒæ­¥ä¸šåŠ¡è¡¨ç»“æ„ï¼Œå®ç°å¯¹ä¸šåŠ¡è¡¨çš„å…¨é¢ç®¡ç†ã€‚

ç¬¬äºŒéƒ¨åˆ†ï¼šæ˜¯åœ¨é€‰æ‹©äº†ç‰¹å®šçš„è¡¨ä¹‹åï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œç³»ç»Ÿå°†æ ¹æ®è¡¨ç»“æ„ï¼Œç”Ÿæˆç›¸åº”çš„å‰åç«¯ä»£ç ï¼Œå¹¶æä¾›ä¸‹è½½ã€‚

![](/Users/zetian/workshop/project/dkd-parent/Note/NodeAssets/ä»£ç ç”Ÿæˆå™¨.png)

## ä¸€ã€æ•°æ®åº“è¡¨ç»“æ„è¯´æ˜

è‹¥ä¾æä¾›äº†ä¸¤å¼ æ ¸å¿ƒè¡¨ï¼Œæ¥å­˜å‚¨å¯¼å…¥çš„ä¸šåŠ¡è¡¨ä¿¡æ¯ï¼š

- `gen_table` è¡¨ï¼šå­˜å‚¨ä¸šåŠ¡è¡¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œå®ƒå¯¹åº”äºé…ç½®ä»£ç â€œåŸºæœ¬ä¿¡æ¯â€å’Œâ€œç”Ÿæˆä¿¡æ¯â€çš„é¡µé¢ï¼›
- `gen_table_column` è¡¨ï¼šå­˜å‚¨ä¸šåŠ¡è¡¨çš„å­—æ®µä¿¡æ¯     å®ƒå¯¹åº”äºé…ç½®ä»£ç â€œå­—æ®µä¿¡æ¯â€çš„é¡µé¢ã€‚

è¿™ä¸¤å¼ è¡¨æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€å¼ ä¸šåŠ¡è¡¨å¯ä»¥æœ‰å¤šä¸ªå­—æ®µçš„ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨å­—æ®µä¿¡æ¯è¡¨ä¸­æœ‰ä¸ªå¤–é”® `table_id` æŒ‡å‘ä¸šåŠ¡è¡¨ä¸­çš„ `table_id` å­—æ®µ

![](/Users/zetian/workshop/project/dkd-parent/Note/NodeAssets/ä»£ç ç”Ÿæˆå™¨è¡¨ç»“æ„å…³ç³».png)

## äºŒã€é¡¹ç›®ç»“æ„è¯´æ˜

### 2.1.åç«¯é¡¹ç›®è¯´æ˜

dkd-generator

```directory
â”œâ”€ğŸ“ src
â”‚â€ƒâ””â”€ğŸ“ main
â”‚â€ƒ  â”œâ”€ğŸ“ java
â”‚â€ƒ  â”‚â€ƒâ””â”€ğŸ“ com
â”‚â€ƒ  â”‚â€ƒ  â””â”€ğŸ“ dkd
â”‚â€ƒ  â”‚â€ƒ    â””â”€ğŸ“ generator
â”‚â€ƒ  â”‚â€ƒ      â”œâ”€ğŸ“ config-------- # è¯»å–ä»£ç ç”Ÿæˆç›¸å…³é…ç½®
â”‚â€ƒ  â”‚â€ƒ      â”œâ”€ğŸ“ controller
â”‚â€ƒ  â”‚â€ƒ      â”œâ”€ğŸ“ domain
â”‚â€ƒ  â”‚â€ƒ      â”œâ”€ğŸ“ mapper
â”‚â€ƒ  â”‚â€ƒ      â”œâ”€ğŸ“ service
â”‚â€ƒ  â”‚â€ƒ      â””â”€ğŸ“ util---------- # Velocity æ¨¡æ¿å·¥å…·ç±»
â”‚â€ƒ  â””â”€ğŸ“ resources
â”‚â€ƒ    â”œâ”€ğŸ“ mapper
â”‚â€ƒ    â”‚â€ƒâ””â”€ğŸ“ generator
â”‚â€ƒ    â”œâ”€ğŸ“ vm
â”‚â€ƒ    â””â”€ğŸ“„ generator.yml
```

### 2.2.å‰ç«¯é¡¹ç›®ç»“æ„

```directory
â”œâ”€ğŸ“ bin
â”œâ”€ğŸ“ html
â”œâ”€ğŸ“ public
â”œâ”€ğŸ“ src
â”‚â€ƒâ”œâ”€ğŸ“ api
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ manage
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ monitor
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ system
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ tool
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“„ gen.js----------------- # Api è¯·æ±‚ Js æ–‡ä»¶
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ login.js
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ menu.js
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“„ page.js
â”‚â€ƒâ”œâ”€ğŸ“ assets
â”‚â€ƒâ”œâ”€ğŸ“ components
â”‚â€ƒâ”œâ”€ğŸ“ directive
â”‚â€ƒâ”œâ”€ğŸ“ layout
â”‚â€ƒâ”œâ”€ğŸ“ plugins
â”‚â€ƒâ”œâ”€ğŸ“ router
â”‚â€ƒâ”œâ”€ğŸ“ store
â”‚â€ƒâ”œâ”€ğŸ“ utils
â”‚â€ƒâ”œâ”€ğŸ“ views
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ error
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ home
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ manage
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ monitor
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ redirect
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ system
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ tool
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ build
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“ gen
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ basicInfoForm.vue---- # åŸºæœ¬ä¿¡æ¯è§†å›¾ç»„ä»¶
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ editTable.vue-------- # å­—æ®µä¿¡æ¯è§†å›¾ç»„ä»¶
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ genInfoForm.vue------ # ç”Ÿæˆä¿¡æ¯è§†å›¾ç»„ä»¶
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ importTable.vue------ # å¯¼å…¥å¯¹è¯æ¡†
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“„ index.vue------------ # ä»£ç ç”Ÿæˆè§†å›¾ç»„å»º
â”‚â€ƒâ”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“ swagger
â”‚â€ƒâ”‚â€ƒâ”œâ”€ğŸ“„ login.vue
â”‚â€ƒâ”‚â€ƒâ””â”€ğŸ“„ register.vue
â”‚â€ƒâ”œâ”€ğŸ“„ App.vue
â”‚â€ƒâ”œâ”€ğŸ“„ main.js
â”‚â€ƒâ”œâ”€ğŸ“„ permission.js
â”‚â€ƒâ””â”€ğŸ“„ settings.js
â”œâ”€ğŸ“ vite
â”œâ”€â€¦â€¦
```

## ä¸‰ã€æºç åˆ†æ

### 3.1.å¯¼å…¥è¡¨ç»“æ„

å½“ç®¡ç†å‘˜åœ¨ç•Œé¢ä¸Šç‚¹å‡»å¯¼å…¥æŒ‰é’®æ—¶ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼›

æ­¤æ—¶ï¼Œå‰ç«¯éœ€è¦å‘åç«¯å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶è¿”å›åˆ°å‰ç«¯ï¼Œå±•ç¤ºå½“å‰é¡¹ç›®åº“ä¸­æ‰€æœ‰å¾…å¯¼å…¥çš„ä¸šåŠ¡è¡¨ã€‚

![](/Users/zetian/workshop/project/dkd-parent/Note/NodeAssets/ä»£ç ç”Ÿæˆ-å¯¼å…¥æ•°æ®åº“è¡¨.png)

æ­¤åŠŸèƒ½æ¶‰åŠå‰ç«¯ç›¸å…³çš„ä»£ç ä½äº`views/tool/gen/index.vue`è¿™ä¸ªè§†å›¾ç»„ä»¶ä¸­ï¼Œè´Ÿè´£å®ç°å¯¼å…¥ä¸šåŠ¡è¡¨çš„ç”¨æˆ·ç•Œé¢å’Œäº¤äº’é€»è¾‘ã€‚

src/views/tool/gen/index.vue

```javascript
/** æ‰“å¼€å¯¼å…¥è¡¨å¼¹çª— */
function openImportTable() {
  proxy.$refs["importRef"].show();
}
```

åç«¯å¤„ç†é€»è¾‘ï¼Œåˆ™åœ¨ä»£ç ç”Ÿæˆæ¨¡å—ï¼ˆ`dkd-generator`ï¼‰çš„`GenController`ä¸­ï¼Œè´Ÿè´£æ¥æ”¶å‰ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶è¿”å›æŸ¥è¯¢ç»“æœã€‚

dkd-generator/src/main/java/com/dkd/generator/controller/GenController.java

```java
/**
 * æŸ¥è¯¢æ•°æ®åº“åˆ—è¡¨
 */
@PreAuthorize("@ss.hasPermi('tool:gen:list')")
@GetMapping("/db/list")
public TableDataInfo dataList(GenTable genTable) {
    startPage();
    List<GenTable> list = genTableService.selectDbTableList(genTable);
    return getDataTable(list);
}
```

XML è¯­å¥å¦‚ä¸‹ï¼š

dkd-generator/src/main/resources/mapper/generator/GenTableMapper.xml

```xml
<select id="selectDbTableList" parameterType="GenTable" resultMap="GenTableResult">
    <!-- æŸ¥è¯¢æ•°æ®åº“è¡¨åˆ—è¡¨ï¼Œæ’é™¤ç‰¹å®šå‰ç¼€çš„è¡¨ï¼Œå¹¶ä¸”ä¸åœ¨ gen_table ä¸­çš„è¡¨ -->
    select table_name, table_comment, create_time, update_time from information_schema.tables
    where table_schema = (select database())
    AND table_name NOT LIKE 'qrtz_%' AND table_name NOT LIKE 'gen_%'
    AND table_name NOT IN (select table_name from gen_table)
    <if test="tableName != null and tableName != ''">
       <!-- æ ¹æ®è¡¨åæ¨¡ç³ŠæŸ¥è¯¢ -->
       AND lower(table_name) like lower(concat('%', #{tableName}, '%'))
    </if>
    <if test="tableComment != null and tableComment != ''">
       <!-- æ ¹æ®è¡¨æ³¨é‡Šæ¨¡ç³ŠæŸ¥è¯¢ -->
       AND lower(table_comment) like lower(concat('%', #{tableComment}, '%'))
    </if>
    <if test="params.beginTime != null and params.beginTime != ''"><!-- å¼€å§‹æ—¶é—´æ£€ç´¢ -->
       <!-- æ ¹æ®å¼€å§‹æ—¶é—´è¿‡æ»¤è¡¨ -->
       AND date_format(create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
    </if>
    <if test="params.endTime != null and params.endTime != ''"><!-- ç»“æŸæ—¶é—´æ£€ç´¢ -->
       <!-- æ ¹æ®ç»“æŸæ—¶é—´è¿‡æ»¤è¡¨ -->
       AND date_format(create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
    </if>
       order by create_time desc
</select>
```

å½“ç®¡ç†å‘˜åœ¨å¯¹è¯æ¡†ä¸­ï¼Œé€‰ä¸­éœ€è¦å¯¼å…¥çš„ä¸šåŠ¡è¡¨ï¼Œç‚¹å‡»ç¡®å®šæŒ‰é’®ï¼Œ

æ­¤æ—¶ï¼Œå‰ç«¯éœ€è¦å‘åç«¯å‘é€è¯·æ±‚ï¼Œä¿å­˜ä¸šåŠ¡è¡¨çš„åŸºæœ¬ä¿¡æ¯å’Œå­—æ®µä¿¡æ¯

æ­¤åŠŸèƒ½ï¼Œæ¶‰åŠå‰ç«¯ç›¸å…³çš„ä»£ç ï¼Œè´Ÿè´£å®ç°å¯¼å…¥ä¸šåŠ¡è¡¨åŠŸèƒ½çš„ç”¨æˆ·ç•Œé¢å’Œäº¤äº’é€»è¾‘ã€‚

src/views/tool/gen/importTable.vue

```javascript
/** å¯¼å…¥æŒ‰é’®æ“ä½œ */
function handleImportTable() {
  const tableNames = tables.value.join(",");
  if (tableNames == "") {
    proxy.$modal.msgError("è¯·é€‰æ‹©è¦å¯¼å…¥çš„è¡¨");
    return;
  }
  importTable({ tables: tableNames }).then(res => {
    proxy.$modal.msgSuccess(res.msg);
    if (res.code === 200) {
      visible.value = false;
      emit("ok");
    }
  });
}
```

åç«¯å¤„ç†é€»è¾‘ï¼Œåˆ™åœ¨ä»£ç ç”Ÿæˆæ¨¡å—çš„`GenController`ä¸­ï¼Œè´Ÿè´£æ¥æ”¶å‰ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¿å­˜ä¸šåŠ¡è¡¨çš„åŸºæœ¬ä¿¡æ¯å’Œå­—æ®µä¿¡æ¯

dkd-generator/src/main/java/com/dkd/generator/controller/GenController.java

```java
/**
 * å¯¼å…¥è¡¨ç»“æ„ï¼ˆä¿å­˜ï¼‰
 */
@PreAuthorize("@ss.hasPermi('tool:gen:import')")
@Log(title = "ä»£ç ç”Ÿæˆ", businessType = BusinessType.IMPORT)
@PostMapping("/importTable")
public AjaxResult importTableSave(String tables) {
    String[] tableNames = Convert.toStrArray(tables);
    // æŸ¥è¯¢è¡¨ä¿¡æ¯
    List<GenTable> tableList = genTableService.selectDbTableListByNames(tableNames);
    // å¯¼å…¥è¡¨ç»“æ„ï¼ˆä¿å­˜ï¼‰
    genTableService.importGenTable(tableList, SecurityUtils.getUsername());
    return success();
}
```

å…·ä½“çš„æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹å›¾ï¼š

```mermaid
graph TD
A(ç‚¹å‡»ç¡®å®š) --> B[æŸ¥è¯¢è¡¨ç»“æ„]
		B --> C[åˆå§‹åŒ–è¡¨ä¿¡æ¯]
		C --> D[æ’å…¥ä¸šåŠ¡è¡¨]
    D --> E{æ˜¯å¦æ’å…¥æˆåŠŸ}
    E --> |no| F(ç»“æŸ)
    E --> |yes| G[æŸ¥è¯¢è¯¥è¡¨çš„åˆ—ä¿¡æ¯]
    G --> H{æ˜¯å¦æœ‰åˆ—ä¿¡æ¯}
    H --> |no| F
    H --> |yes| I[åˆå§‹åŒ–åˆ—ä¿¡æ¯ï¼Œå…³è”è¡¨]
    I --> J[æ’å…¥åˆ—è¡¨ä¿¡æ¯]
    J --> H
```

### 3.2.ç”Ÿæˆä»£ç 

é¦–å…ˆç®¡ç†å‘˜ï¼Œé€‰ä¸­éœ€è¦ä¸‹è½½çš„ä¸šåŠ¡è¡¨ï¼Œå¹¶ç‚¹å‡»â€œç”Ÿæˆâ€æŒ‰é’®ï¼Œæ¥è§¦å‘ä»£ç ç”Ÿæˆå¹¶ä¸‹è½½çš„è¿‡ç¨‹ã€‚

å‰ç«¯éšåå‘åç«¯å‘é€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå‘ŠçŸ¥æœåŠ¡å™¨éœ€è¦ç”Ÿæˆä»£ç çš„ä¸šåŠ¡è¡¨ã€‚

src/views/tool/gen/index.vue

```javascript
/** ç”Ÿæˆä»£ç æ“ä½œ */
function handleGenTable(row) {
  const tbNames = row.tableName || tableNames.value;
  if (tbNames == "") {
    proxy.$modal.msgError("è¯·é€‰æ‹©è¦ç”Ÿæˆçš„æ•°æ®");
    return;
  }
  if (row.genType === "1") {
    genCode(row.tableName).then(response => {
      proxy.$modal.msgSuccess("æˆåŠŸç”Ÿæˆåˆ°è‡ªå®šä¹‰è·¯å¾„ï¼š" + row.genPath);
    });
  } else {
    proxy.$download.zip("/tool/gen/batchGenCode?tables=" + tbNames, "ruoyi.zip");
  }
}
```

åç«¯çš„é€»è¾‘å¤„ç†åˆ™åœ¨ä»£ç ç”Ÿæˆæ¨¡å—çš„ `GenController` æ§åˆ¶å™¨ç±»ä¸­ã€‚

è¿™é‡Œæ˜¯å¤„ç†å‰ç«¯è¯·æ±‚ã€æ‰§è¡Œä»£ç ç”Ÿæˆé€»è¾‘ï¼Œå°†ç”Ÿæˆçš„ä»£ç å­—èŠ‚æµé€šè¿‡ HTTP å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

dkd-generator/src/main/java/com/dkd/generator/controller/GenController.java

```java
/**
 * æ‰¹é‡ç”Ÿæˆä»£ç 
 */
@PreAuthorize("@ss.hasPermi('tool:gen:code')")
@Log(title = "ä»£ç ç”Ÿæˆ", businessType = BusinessType.GENCODE)
@GetMapping("/batchGenCode")
public void batchGenCode(HttpServletResponse response, String tables) throws IOException {
    String[] tableNames = Convert.toStrArray(tables);
    byte[] data = genTableService.downloadCode(tableNames);
    genCode(response, data);
}
```

å…·ä½“çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

```mermaid
graph TD
A(ç‚¹å‡»ç”Ÿæˆ) --> B[æŸ¥è¯¢ä¸šåŠ¡è¡¨å’Œå­—æ®µä¿¡æ¯]
    B --> C[åˆå§‹åŒ– Velocity æ¨¡æ¿å¼•æ“]
    C --> D[è®¾ç½®æ¨¡æ¿å˜é‡]
    D --> E[è·å–æ¨¡æ¿åˆ—è¡¨]
    E --> F{æ˜¯å¦æœ‰æ¨¡æ¿}
    F --> |yes| G[æ¸²æŸ“æ¨¡æ¿]
    G --> H[å°†æ¸²æŸ“ç»“æœæ·»åŠ åˆ° zip æ–‡ä»¶å¤¹]
    H --> F
    F --> |no| I(è¿”å›å®¢æˆ·ç«¯)
    H --> I
    
```

#### 2.3.ä¿®æ”¹é…ç½®

æˆ‘ä»¬å·²ç»å¯¹ä»£ç ç”Ÿæˆå™¨çš„å·¥ä½œåŸç†æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è§£å†³ä¸€äº›é¡¹ç›®ä¸­ä½¿ç”¨çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

æ¯æ¬¡ç”Ÿæˆä»£ç éƒ½éœ€è¦æ‰§è¡Œä¿®æ”¹ä½œè€…ï¼Œå»é™¤å®ä½“ç±»å‰ç¼€ç­‰æ“ä½œï¼Œè¿‡äºç¹çï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ `generator.yml` é…ç½®æ–‡ä»¶æ¥ï¼Œè¿›è¡Œè°ƒæ•´ã€‚

dkd-generator/src/main/resources/generator.yml

```yaml
# ä»£ç ç”Ÿæˆ
gen:
  # ä½œè€…
  author: zetian
  # é»˜è®¤ç”ŸæˆåŒ…è·¯å¾„ system éœ€æ”¹æˆè‡ªå·±çš„æ¨¡å—åç§° å¦‚ system monitor tool
  packageName: com.dkd.manage
  # è‡ªåŠ¨å»é™¤è¡¨å‰ç¼€ï¼Œé»˜è®¤æ˜¯false
  autoRemovePre: false
  # è¡¨å‰ç¼€ï¼ˆç”Ÿæˆç±»åä¸ä¼šåŒ…å«è¡¨å‰ç¼€ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
  tablePrefix: sys_
```

## å››ã€Velocity æ¨¡æ¿å¼•æ“

æˆ‘ä»¬è¿˜æƒ³åœ¨è‹¥ä¾ä»£ç ç”Ÿæˆçš„åŸºç¡€ä¸Šç»§ç»­è¿›è¡Œå¢å¼º

å®ä½“ç±»æ”¯æŒ Lombokï¼Œæ¯”å¦‚å®ç°å¦‚ä¸‹æ•ˆæœï¼š

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Order extends BaseEntity {
    private Long id;
    private String orderNo;
    // æ²¡æœ‰getã€setã€toStringæ–¹æ³•äº†
}
```

Controller ç±»æ”¯æŒ Swagger æ³¨è§£ã€‚æ¯”å¦‚å®ç°å¦‚ä¸‹æ•ˆæœï¼š

```java
@Api(tags = "è®¢å•ç®¡ç†Controller")
public class OrderController extends BaseController{
    @ApiOperation("æŸ¥è¯¢è®¢å•ç®¡ç†åˆ—è¡¨")
    public TableDataInfo list(...){
    	return success(...);
    }
    @ApiOperation("è·å–è®¢å•ç®¡ç†è¯¦ç»†ä¿¡æ¯")
    public AjaxResult getInfo(...) {
       return success(...);
    }
}
```

è¦å®ç°è¿™äº›å¢å¼ºåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æŒæ¡ Velocity æ¨¡æ¿å¼•æ“çš„ä½¿ç”¨ã€‚Velocity å…è®¸æˆ‘ä»¬å®šåˆ¶å’Œä¼˜åŒ–ä»£ç ç”Ÿæˆæ¨¡æ¿ã€‚

### 4.1.Velocity ä»‹ç»

Velocity æ˜¯ä¸€ä¸ªåŸºäº Java çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥é€šè¿‡ç‰¹å®šçš„è¯­æ³•ï¼Œè·å–åœ¨ java å¯¹è±¡çš„æ•°æ® , å¡«å……åˆ°æ¨¡æ¿ä¸­ï¼Œä»è€Œå®ç°ç•Œé¢å’Œ java ä»£ç çš„åˆ†ç¦» !

```mermaid
graph LR
A[æ•°æ®æ¨¡å‹] -->B(åˆå¹¶)
C[æ¨¡æ¿] -->B
B --> D[æ–‡ä»¶ html, javaâ€¦]
```

æ¯”å¦‚åœ¨å¼€å±€ç”µå­å‘ç¥¨ç‚¹åœºæ™¯ä¸­ï¼Œå›ºå®šçš„ç”µå­å‘ç¥¨æ ¼å¼å°±æ˜¯â€œæ¨¡æ¿â€ï¼Œè€Œæ¯æ¬¡ä¸åŒçš„å¼€ç¥¨äººå°±æ˜¯â€œæ•°æ®æ¨¡å‹â€ã€‚

Velocity å¸¸è§çš„åº”ç”¨åœºæ™¯æœ‰ï¼š

- Web å†…å®¹ç”Ÿæˆï¼šç”ŸæˆåŠ¨æ€ Web é¡µé¢ã€‚
- ä»£ç ç”Ÿæˆ  : ç”Ÿæˆ Java æºä»£ç ã€SQL è„šæœ¬ã€XML é…ç½®æ–‡ä»¶ç­‰ã€‚
- ç½‘é¡µé™æ€åŒ–  : ç”Ÿæˆé™æ€ç½‘é¡µã€‚

### 4.2.Velocity å…¥é—¨æ¡ˆä¾‹

éœ€æ±‚ï¼šæ ¹æ®ä¸‹é¢ html æ¨¡æ¿ï¼Œå®Œæˆå¯¹æ•°æ®çš„å¡«å……

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
    <h3>å¿ƒæ€€æ¢¦æƒ³ï¼ŒåšæŒä¸æ‡ˆï¼ŒæˆåŠŸå³åœ¨å‰æ–¹ã€‚åŠ æ²¹å°‘å¹´ï¼ï¼</h3> 
</body>
</html>
```

å°†â€œåŠ æ²¹å°‘å¹´â€ï¼Œè¿™å‡ ä¸ªå­—ï¼Œéœ€è¦è¿›è¡ŒåŠ¨æ€å¡«å……ã€‚æ¯”å¦‚ï¼š`åŠ æ²¹åŒå­¦ï¼ï¼`ã€`åŠ æ²¹å¥³å­©ï¼ï¼`ã€`åŠ æ²¹æœ‹å‹ï¼ï¼`

> åœ¨ Maven é¡¹ç›®ä¸­ï¼Œåˆ›å»º test ç›®å½•ï¼Œåœ¨å…¶ä¸­ç¼–å†™çš„æµ‹è¯•ä»£ç ï¼Œä¸ä¼šè¢«æ‰“åŒ…ã€‚

å‡†å¤‡æ¨¡æ¿

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
		<h3>å¿ƒæ€€æ¢¦æƒ³ï¼ŒåšæŒä¸æ‡ˆï¼ŒæˆåŠŸå³åœ¨å‰æ–¹ã€‚${message}</h3>
</body>
</html>
```

è‹¥ä¾å°è£…äº† Velocity æ¨¡æ¿å¼•æ“åˆå§‹åŒ–ç›¸å…³çš„ä»£ç ã€‚

dkd-generator/src/main/java/com/dkd/generator/util/VelocityInitializer.java

```java
package com.dkd.generator.util;

import java.util.Properties;

import org.apache.velocity.app.Velocity;
import com.dkd.common.constant.Constants;

/**
 * VelocityEngineå·¥å‚
 *
 * @author ruoyi
 */
public class VelocityInitializer {
    /**
     * åˆå§‹åŒ–vmæ–¹æ³•
     */
    public static void initVelocity() {
        Properties p = new Properties();
        try {
            // åŠ è½½classpathç›®å½•ä¸‹çš„vmæ–‡ä»¶
            p.setProperty("resource.loader.file.class", "org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader");
            // å®šä¹‰å­—ç¬¦é›†
            p.setProperty(Velocity.INPUT_ENCODING, Constants.UTF8);
            // åˆå§‹åŒ–Velocityå¼•æ“ï¼ŒæŒ‡å®šé…ç½®Properties
            Velocity.init(p);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}
```

ç¼–å†™æµ‹è¯•ç±»ä»£ç ï¼Œå®ç°æ•°æ®å¡«å……ï¼Œå¹¶ç”Ÿæˆæ–‡ä»¶ã€‚

dkd-generator/src/test/java/com/dkd/test/VelcityDemoTest.java

```java
package com.dkd.test;

import com.dkd.generator.util.VelocityInitializer;
import org.apache.velocity.Template;
import org.apache.velocity.VelocityContext;
import org.apache.velocity.app.Velocity;

import java.io.FileWriter;
import java.io.IOException;

public class VelcityDemoTest {
    public static void main(String[] args) throws IOException {
        // 1.åˆå§‹åŒ–æ¨¡æ¿å¼•æ“
        VelocityInitializer.initVelocity();

        // 2.å‡†å¤‡æ¨¡æ¿æ•°æ®æ¨¡å‹
        VelocityContext vc = new VelocityContext();
        vc.put("message", "åŠ æ²¹å°‘å¹´ï¼ï¼");

        // 3.è¯»å–æ¨¡ç‰ˆ
        Template template = Velocity.getTemplate("vm/index.html.vm", "UTF-8");

        // 4.æ¸²æŸ“æ¨¡æ¿ï¼ˆåˆå¹¶è¾“å‡ºï¼‰
        FileWriter fw = new FileWriter("/Users/zetian/Downloads/index.html");
        template.merge(vc, fw);

        // 5.å…³é—­æµ
        fw.close();
    }
}
```

æ‰§è¡Œ main æ–¹æ³•ï¼Œåœ¨æŒ‡å®šç›®å½•ä¸‹ï¼Œç”Ÿæˆ index.html æ–‡ä»¶ã€‚

### 4.3.Velocity åŸºç¡€è¯­æ³•

#### 4.3.1.ç®€å•ç±»å‹

Velocity ä¸­çš„å˜é‡æœ‰ä¸¤ç±»ï¼š

- åœ¨æ¨¡æ¿ä¸­å®šä¹‰å˜é‡ï¼š `#set` å¼€å¤´ï¼›æ¯”å¦‚ï¼š`#set($name = "velocity")`
- è·å–å˜é‡çš„å€¼ï¼š æ¯”å¦‚ï¼š `$name`  æˆ–è€…  `${name}`

å‡†å¤‡æ¨¡æ¿

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
    <h3>å¿ƒæ€€æ¢¦æƒ³ï¼ŒåšæŒä¸æ‡ˆï¼ŒæˆåŠŸå³åœ¨å‰æ–¹ã€‚${message}</h3>

    ## å®šä¹‰å˜é‡
    #set($name = "Velocity")

    ## è¾“å‡ºå˜é‡
    ç¬¬ä¸€ç§æƒ…å†µï¼š${name} <br>
    ç¬¬äºŒç§æƒ…å†µï¼š$name <br>
</body>
</html>
```

- ç¬¬äºŒç§æ–¹å¼ï¼Œç›¸è¾ƒäºç¬¬ä¸€ç§æ–¹å¼å†™èµ·æ¥æ›´ç®€æ´ï¼Œä½†ä¸èƒ½ä¸å…¶å®ƒå­—ç¬¦ä¸²æ‹¼æ¥ã€‚

#### 4.3.2.å¯¹è±¡ç±»å‹

å‡†å¤‡æ¨¡æ¿

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
    ## è·å–åŒºåŸŸå¯¹è±¡ä¸­çš„æ•°æ®
    $region <br>
    åŒºåŸŸIdï¼š$region.id <br>
    åŒºåŸŸåç§°ï¼š$region.name <br>
</body>
</html>
```

æµ‹è¯•ç±»ï¼š

dkd-generator/src/test/java/com/dkd/test/VelcityDemoTest.java

```java
package com.dkd.test;

import com.dkd.generator.util.VelocityInitializer;
import org.apache.velocity.Template;
import org.apache.velocity.VelocityContext;
import org.apache.velocity.app.Velocity;

import java.io.FileWriter;
import java.io.IOException;

public class VelcityDemoTest {
    public static void main(String[] args) throws IOException {
        // 1.åˆå§‹åŒ–æ¨¡æ¿å¼•æ“
        VelocityInitializer.initVelocity();

        // 2.å‡†å¤‡æ¨¡æ¿æ•°æ®æ¨¡å‹
        VelocityContext vc = new VelocityContext();

        // 2.åˆ›å»ºåŒºåŸŸå¯¹è±¡
        Region region = new Region(1L, "åŒ—äº¬åŒ—äº”ç¯");
        vc.put("region", region);

        // 3.è¯»å–æ¨¡ç‰ˆ
        Template template = Velocity.getTemplate("vm/index.html.vm", "UTF-8");

        // 4.æ¸²æŸ“æ¨¡æ¿ï¼ˆåˆå¹¶è¾“å‡ºï¼‰
        FileWriter fw = new FileWriter("/Users/zetian/Downloads/index.html");
        template.merge(vc, fw);

        // 5.å…³é—­æµ
        fw.close();
    }
}
```

#### 4.3.3.å¾ªç¯è¯­æ³•

å¾ªç¯çš„è¯­æ³•ï¼š`#foreach(...) ... #end`

##### 4.3.3.1.ç®€å•ç±»å‹å¾ªç¯

å‡†å¤‡æ¨¡æ¿

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
    #set($list=["æ˜¥", "å¤", "ç§‹", "å†¬"])

    ## ä¾¿åˆ©å¾ªç¯
    #foreach($item in $list)
       $foreach.count.$itemï¼Œ$foreach.index.$item <br> ## count ä» 1 å¼€å§‹ï¼Œindex ä» 0 å¼€å§‹
    #end
</body>
</html>
```

##### 4.3.3.2.å¯¹è±¡ç±»å‹å¾ªç¯

å‡†å¤‡æ¨¡ç‰ˆ

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>
    #foreach($item in $regionList)
        $item.idï¼Œ$item.name <br>
    #end
</body>
</html>
```

æµ‹è¯•ç±»

dkd-generator/src/test/java/com/dkd/test/VelcityDemoTest.java

```java
package com.dkd.test;

import com.dkd.generator.util.VelocityInitializer;
import org.apache.velocity.Template;
import org.apache.velocity.VelocityContext;
import org.apache.velocity.app.Velocity;

import java.io.FileWriter;
import java.io.IOException;
import java.util.List;

public class VelcityDemoTest {
    public static void main(String[] args) throws IOException {
        // 1.åˆå§‹åŒ–æ¨¡æ¿å¼•æ“
        VelocityInitializer.initVelocity();

        // 2.å‡†å¤‡æ¨¡æ¿æ•°æ®æ¨¡å‹
        VelocityContext vc = new VelocityContext();
        vc.put("message", "åŠ æ²¹å°‘å¹´ï¼ï¼");

        // åˆ›å»ºåŒºåŸŸå¯¹è±¡
        Region region1 = new Region(1L, "åŒ—äº¬åŒ—äº”ç¯");
        Region region2 = new Region(2L, "ä¸Šæµ·å—å››ç¯");
        List<Region> list = List.of(region1, region2);
        vc.put("regionList", list);

        // 3.è¯»å–æ¨¡ç‰ˆ
        Template template = Velocity.getTemplate("vm/index.html.vm", "UTF-8");

        // 4.æ¸²æŸ“æ¨¡æ¿ï¼ˆåˆå¹¶è¾“å‡ºï¼‰
        FileWriter fw = new FileWriter("/Users/zetian/Downloads/index.html");
        template.merge(vc, fw);

        // 5.å…³é—­æµ
        fw.close();
    }
}
```

> `List.of` æ˜¯ jdk 9 ä¸­çš„æ–¹æ³•ã€‚
>
> è‹¥ä¾çˆ¶å·¥ç¨‹ä¸­é»˜è®¤æŒ‡å®šçš„ Java ç‰ˆæœ¬æ˜¯ 1.8ï¼Œå°†å®ƒæ”¹ä¸ºå®é™…ä½¿ç”¨çš„ java ç‰ˆæœ¬
>
> pom.xml
>
> ```xml
> <properties>
>     <java.version>17</java.version>
> </properties>
> ```

#### 4.3.4.æ¡ä»¶åˆ¤æ–­

åˆ¤æ–­çš„è¯­æ³•ï¼š`#if(condition) ... #elseif(condition) ... #else ... #end`

å‡†å¤‡æ¨¡æ¿

dkd-generator/src/test/resources/vm/index.html.vm

```velocity
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>velocityå¿«é€Ÿå…¥é—¨</title>
</head>
<body>

    ## å®šä¹‰æˆç»©è¡¨é‡
    #set($score=80)

    ## ifåˆ¤æ–­
    #if($score >= 80)
        ä¼˜ç§€
    #elseif($score >= 60)
        åŠæ ¼
    #else
        ä¸åŠæ ¼
    #end
</body>
</html>
```

å¯¹è±¡ä¸ºç©ºçš„é€»è¾‘åˆ¤æ–­ï¼š

```velocity
## å¯¹è±¡ obj ä¸ä¸ºç©ºï¼Œæ‰ä¼šæ‰§è¡Œé‡Œé¢çš„é€»è¾‘
#if($obj) ..... #end

## å¯¹è±¡ obj ä¸ºç©ºï¼Œæ‰ä¼šæ‰§è¡Œé‡Œé¢çš„é€»è¾‘
#if(!$obj) ..... #end
```

åœ¨æ¡ä»¶åˆ¤æ–­ä¸­ï¼Œvelocity æ”¯æŒå¸¸è§çš„å…³ç³»æ“ä½œç¬¦ï¼Œæ¯”å¦‚ï¼š`&&`ï¼ˆä¸ï¼‰ï¼Œ`||`ï¼ˆæˆ–ï¼‰ï¼Œ `!`ï¼ˆéï¼‰

### 4.4.è‹¥ä¾ä¸­çš„æ¨¡æ¿

æŸ¥çœ‹å®ä½“ç±»æ¨¡ç‰ˆ

dkd-generator/src/main/resources/vm/java/domain.java.bak.vm

æŸ¥çœ‹æ§åˆ¶å™¨ç±»æ¨¡ç‰ˆ

dkd-generator/src/main/resources/vm/java/domain.java.vm

## äº”ã€è‹¥ä¾æ¨¡ç‰ˆé›†æˆ Lombok

åœ¨é¡¹ç›®ä¸­å¼•å…¥ Lombok ä¾èµ–

dkd-common/pom.xml

```xml
<!--  lombokå·¥å…·-->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>
```

åœ¨å®ä½“ç±»æ¨¡ç‰ˆä¸­

- ä½¿ç”¨ lombok æä¾›çš„æ³¨è§£ï¼Œå¹¶å¯¼å…¥ç›¸åº”çš„åŒ…
- åˆ é™¤ç”Ÿæˆ getterã€setter æ–¹æ³•çš„ä»£ç 
- åˆ é™¤ç”Ÿæˆ `toString` æ–¹æ³•çš„ä»£ç ã€‚
- åˆ é™¤ `ToStringBuilder`ã€`ToStringStyle` ä¸¤ä¸ªç±»çš„å¯¼åŒ…

dkd-generator/src/main/resources/vm/java/domain.java.vm

```velocity
// åŒ…å£°æ˜
package ${packageName}.domain;

// å¯¼å…¥åˆ—è¡¨
    #foreach ($import in $importList)
    import ${import};
    #end

// å¯¼å…¥å¸¸ç”¨å·¥å…·ç±»
import com.dkd.common.annotation.Excel;

// æ ¹æ®è¡¨ç±»å‹å¯¼å…¥ä¸åŒçš„åŸºç±»
    #if($table.crud || $table.sub)
    import com.dkd.common.core.domain.BaseEntity;
    #elseif($table.tree)
    import com.dkd.common.core.domain.TreeEntity;
    #end

    ## å¯¼å…¥ lombok æ³¨è§£
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

/**
 * ${functionName}å¯¹è±¡ ${tableName}
 *
 * @author ${author}
 * @date ${datetime}
 */
    #if($table.crud || $table.sub)
        #set($Entity="BaseEntity")
    #elseif($table.tree)
        #set($Entity="TreeEntity")
    #end
        @EqualsAndHashCode(callSuper = true)
        @Data
        @NoArgsConstructor
        @AllArgsConstructor
        public class ${ClassName} extends ${Entity} {
        private static final long serialVersionUID = 1L; ## å®šä¹‰ç±»çš„åºåˆ—å·

    ## è·å–ä¸šåŠ¡è¡¨æ‰€æœ‰åˆ—çš„å±æ€§
    #foreach ($column in $columns)
        ## å¦‚æœä¸æ˜¯çˆ¶ç±»å±æ€§ï¼Œåˆ™ç”Ÿæˆ
        #if(!$table.isSuperColumn($column.javaField))
                /** $column.columnComment */
            #if($column.list)
                #set($parentheseIndex=$column.columnComment.indexOf("ï¼ˆ"))
                #if($parentheseIndex != -1)
                    #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                #else
                    #set($comment=$column.columnComment)
                #end
                #if($parentheseIndex != -1)
                @Excel(name = "${comment}", readConverterExp = "$column.readConverterExp()")
                #elseif($column.javaType == 'Date')
                @JsonFormat(pattern = "yyyy-MM-dd")
                @Excel(name = "${comment}", width = 30, dateFormat = "yyyy-MM-dd")
                #else
                @Excel(name = "${comment}")
                #end
            #end
        private $column.javaType $column.javaField;

        #end
    #end

    ## å¦‚æœè¡¨æœ‰å­è¡¨ï¼Œå®šä¹‰å­è¡¨ä¿¡æ¯çš„é›†åˆ
    #if($table.sub)
            /** $table.subTable.functionNameä¿¡æ¯ */
            private List<${subClassName}> ${subclassName}List;
    #end
        }
```

## å…­ã€è‹¥ä¾æ¨¡ç‰ˆé›†æˆ Swagger

è‹¥ä¾é¡¹ç›®ä¸­ï¼Œå·²ç»é›†æˆäº† Swagger ä¾èµ–çš„åæ ‡ã€‚

åœ¨ `dkd-generator` æ¨¡å—çš„ `controller.java.vm` æ¨¡æ¿ä¸­æ·»åŠ  Swagger æ³¨è§£ï¼›

- åœ¨ç±»ä¸Šï¼Œæ·»åŠ  `@Api` æ³¨è§£ã€‚
- åœ¨ç±»çš„æ–¹æ³•å‚»å§‘å¨˜ï¼Œæ·»åŠ  `@ApiOperation` æ³¨è§£ã€‚
- å‚è€ƒä¸Šä¸€ç« ï¼Œå°† `AjaxResult` è¿”å›ç±»å‹ï¼Œæ”¹ä¸º `R`ï¼Œç”¨äºåœ¨æ¥å£æ–‡æ¡£ä¸­ç”Ÿæˆè¿”å›å‚æ•°ã€‚

dkd-generator/src/main/resources/vm/java/controller.java.vm
